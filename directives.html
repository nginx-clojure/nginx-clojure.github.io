<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta content="True" name="HandheldFriendly">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="viewport" content="width=device-width">    
    <meta name="description" content="nginx-clojure.github.io : Nginx module for embedding Clojure / Java / Groovy programs, typically those Ring based handlers">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    


		<!-- bootstrap cdn -->
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
		
		<!-- Optional theme -->
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
		<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.0.min.js"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
		
		<script src="javascripts/fix.js"></script>
		
		<link rel="stylesheet" type="text/css" media="screen" href="stylesheets/my.css">
    <title>Directives Reference@Nginx-Clojure</title>
  </head>

  <body>
  <div id="header">
       <!-- HEADER -->
    <nav id="header_wrap" class="" role="navigation">
        <header id="header_logo_title"  class="inner container">
          <ul class="external-link-buttons">
	          <li>
             <a id="forkme_banner" href="https://github.com/nginx-clojure/nginx-clojure" target="_blank">View on GitHub</a>
            </li>
<!--             <li>
             <a id="google_group_banner" href="https://groups.google.com/forum/#!forum/nginx-clojure" target="_blank">Google Group</a>
            </li> -->
	        </ul>
          <div id="project_logo">
          <h1 id="project_title">nginx-clojure</h1>
          <ul class="social-buttons">
	          <li>
	            <iframe class="github-btn" src="github-btn.html?user=nginx-clojure&repo=nginx-clojure&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="102px" height="20px"></iframe>
	          </li>
	          <li>
	            <iframe class="github-btn" src="github-btn.html?user=nginx-clojure&repo=nginx-clojure&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="100px" height="20px"></iframe>
	          </li>
	        </ul></div>
          <h6 id="project_tagline">Nginx module for embedding Clojure / Java / Groovy programs, typically those Ring based handlers</h6>
        </header>
         <div class="btn-group" style="border-top-width: 1px;border-top-color: #fff;">
          <a href="index.html" class="btn btn-sample btn-md"><span class="glyphicon glyphicon-home"></span> Home</a>
          <a href="quickstart.html" class="btn btn-sample btn-md"><span class="glyphicon glyphicon-flash"></span> Quick Start</a>
          <a href="downloads.html" class="btn btn-sample btn-md"><span class="glyphicon glyphicon-download-alt"></span> Downloads</a>
          <a href="installation.html" class="btn btn-sample btn-md"><span class="glyphicon glyphicon-hdd"></span> Installation</a>
          <div class="btn-group">
          <button type="button" class="btn btn-sample btn-md dropdown-toggle" data-toggle="dropdown" id="docDropDownBtn"><span class="glyphicon glyphicon-cog"></span> Configuration <span class="caret"></span></button>
					<ul class="dropdown-menu" role="menu">
						<li><a href="configuration.html#user-content-21-jvm-path--class-path--other-jvm-options"><span class="glyphicon glyphicon-cog"></span> JVM Path,Class Path & Other JVM Options</a></li>
						<li><a href="configuration.html#user-content-22-initialization-handler-for-nginx-worker"><span class="glyphicon glyphicon-cog"></span> Initialization Handler for nginx worker</a></li>
						<li><a href="configuration.html#user-content-23-content-ring-handler-for-location"><span class="glyphicon glyphicon-cog"></span> Content Ring Handler for Location</a></li>
						<li><a href="configuration.html#user-content-24-chose--coroutine-based-socket-or-asynchronous-socketchannel-or-thread-pool-for-slow-io-operations"><span class="glyphicon glyphicon-cog"></span> Coroutine/Asynchronous Client Channel/Thread Pool </a></li>
						<li><a href="configuration.html#user-content-25-nginx-rewrite-handler"><span class="glyphicon glyphicon-cog"></span> Nginx Rewrite Handler</a></li>
						<li><a href="configuration.html#user-content-26-nginx-access-handler"><span class="glyphicon glyphicon-cog"></span> Nginx Access Handler</a></li>
						<li><a href="configuration.html#user-content-27-nginx-header-filter"><span class="glyphicon glyphicon-cog"></span> Nginx Header Filter</a></li>
						<li><a href="configuration.html#user-content-28-nginx-body-filter"><span class="glyphicon glyphicon-cog"></span> Nginx Body Filter</a></li>
						<li><a href="configuration.html#user-content-29-nginx-log-handler"><span class="glyphicon glyphicon-cog"></span> Nginx Log Handler</a></li>
					</ul>
					</div>
					<div class="btn-group">
          <button type="button" class="btn btn-sample btn-md dropdown-toggle" data-toggle="dropdown" id="docDropDownBtn"><span class="glyphicon glyphicon-book"></span> Documents <span class="caret"></span></button>
					<ul class="dropdown-menu" role="menu">
<!-- 						<li><a href="quickstart.html"><span class="glyphicon glyphicon-flash"></span> Quick Start</a></li> -->
            <li><a href="directives.html"><span class="glyphicon glyphicon-th-list text-warning"></span> Directives Reference</a></li>
						<li><a href="embed.html"><span class="glyphicon glyphicon-gift"></span> Embedding Nginx-Clojure into A standard App</a></li>
						<li><a href="more.html#34-server-channel-for-long-polling--server-sent-events-sse"><span class="glyphicon glyphicon-envelope"></span> Server Channel for Long Polling & Server Sent Events</a></li>
						<li><a href="subpub.html"><span class="glyphicon glyphicon-envelope text-warning"></span> Pub/Sub Among Nginx Worker Processes</a></li>
            <li><a href="sharedmap.html"><span class="glyphicon glyphicon-envelope text-warning"></span> Shared Map & Session Store</a></li>
						<li><a href="more.html#user-content-36-asynchronous-client-channel"><span class="glyphicon glyphicon-road"></span> Asynchronous Client Channel</a></li>
						<li><a href="more.html#user-content-37--about-logging"><span class="glyphicon glyphicon-th-list"></span> About Logging</a></li>
						<li><a href="more.html#user-content-38--sever-side-websocket"><span class="glyphicon glyphicon-th-list"></span> Sever Side WebSocket</a></li>
						<li><a href="more.html#user-content-39--java-standard-restful-web-services-with-jersey"><span class="glyphicon glyphicon-th-list"></span> Java standard RESTful web services with Jersey</a></li>
						<li><a href="more.html#user-content-310-embeding-tomcat"><span class="glyphicon glyphicon-th-list"></span> Embeding Tomcat</a></li>
						<li><a href="more.html#user-content-311-more-about-nginx-worker-process"><span class="glyphicon glyphicon-th-list"></span> More about Nginx Worker Process</a></li>
						<li><a href="more.html"><span class="glyphicon glyphicon-th-list"></span> More about Nginx-Clojure</a></li>
						<li><a href="api/"><span class="glyphicon glyphicon-book text-warning"></span> API Reference (Clojure)</a></li>
					</ul>
					</div>
			<a href="userfullLinks.html" class="btn btn-sample btn-md"><span class="glyphicon glyphicon-share-alt"></span> Useful Links</a>
          </div>  
    </nav>

  </div>
      <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
           <h1>
<a id="user-content-directives-reference" class="anchor" href="#directives-reference" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Directives Reference</h1>
<ul>
<li><a href="#user-content-jvm_path">jvm_path</a></li>
<li><a href="#user-content-jvm_var">jvm_var</a></li>
<li><a href="#user-content-jvm_classpath">jvm_classpath</a></li>
<li><a href="#user-content-jvm_classpath_check">jvm_classpath_check</a></li>
<li><a href="#user-content-jvm_workers">jvm_workers</a></li>
<li><a href="#user-content-jvm_options">jvm_options</a></li>
<li><a href="#user-content-jvm_handler_type">jvm_handler_type</a></li>
<li><a href="#user-content-jvm_init_handler_name">jvm_init_handler_name</a></li>
<li><a href="#user-content-jvm_init_handler_code">jvm_init_handler_code</a></li>
<li><a href="#user-content-jvm_exit_handler_name">jvm_exit_handler_name</a></li>
<li><a href="#user-content-jvm_exit_handler_code">jvm_exit_handler_code</a></li>
<li><a href="#user-content-handlers_lazy_init">handlers_lazy_init</a></li>
<li><a href="#user-content-auto_upgrade_ws">auto_upgrade_ws</a></li>
<li><a href="#user-content-content_handler_type">content_handler_type</a></li>
<li><a href="#user-content-content_handler_name">content_handler_name</a></li>
<li><a href="#user-content-content_handler_code">content_handler_code</a></li>
<li><a href="#user-content-content_handler_property">content_handler_property</a></li>
<li><a href="#user-content-rewrite_handler_type">rewrite_handler_type</a></li>
<li><a href="#user-content-rewrite_handler_name">rewrite_handler_name</a></li>
<li><a href="#user-content-rewrite_handler_code">rewrite_handler_code</a></li>
<li><a href="#user-content-rewrite_handler_property">rewrite_handler_property</a></li>
<li><a href="#user-content-access_handler_type">access_handler_type</a></li>
<li><a href="#user-content-access_handler_name">access_handler_name</a></li>
<li><a href="#user-content-access_handler_code">access_handler_code</a></li>
<li><a href="#user-content-access_handler_property">access_handler_property</a></li>
<li><a href="#user-content-header_filter_type">header_filter_type</a></li>
<li><a href="#user-content-header_filter_name">header_filter_name</a></li>
<li><a href="#user-content-header_filter_code">header_filter_code</a></li>
<li><a href="#user-content-header_filter_property">header_filter_property</a></li>
<li><a href="#user-content-body_filter_type">body_filter_type</a></li>
<li><a href="#user-content-body_filter_name">body_filter_name</a></li>
<li><a href="#user-content-body_filter_code">body_filter_code</a></li>
<li><a href="#user-content-body_filter_property">body_filter_property</a></li>
<li><a href="#user-content-log_handler_type">log_handler_type</a></li>
<li><a href="#user-content-log_handler_name">log_handler_name</a></li>
<li><a href="#user-content-log_handler_code">log_handler_code</a></li>
<li><a href="#user-content-log_handler_property">log_handler_property</a></li>
<li><a href="#user-content-always_read_body">always_read_body</a></li>
<li><a href="#user-content-shared_map">shared_map</a></li>
<li><a href="#user-content-write_page_size">write_page_size</a></li>
</ul>
<h2>
<a id="user-content-jvm_path" class="anchor" href="#jvm_path" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_path</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_path</strong> auto | <em>path</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>Defines jvm shared library path. When <code>auto</code> is used it will auto-detect jvm path otherwise it should be a real jvm shared library path. e.g.</p>
<ul>
<li>On Windows 32-bit it maybe is</li>
</ul>
<pre><code>C:/Program Files/Java/jdk1.7.0_25/jre/bin/server/jvm.dll
</code></pre>
<ul>
<li>On MacOSX it maybe is</li>
</ul>
<pre><code>/Library/Java/JavaVirtualMachines/1.6.0_65-b14-462.jdk/Contents/Libraries/libserver.dylib
   or 
/Library/Java/JavaVirtualMachines/jdk1.7.0_55.jdk/Contents/Home/jre/lib/server/libjvm.dylib
</code></pre>
<ul>
<li>On Ubuntu, it maybe is</li>
</ul>
<pre><code>/usr/lib/jvm/java-7-oracle/jre/lib/amd64/server/libjvm.so`;
</code></pre>
<ul>
<li>On CentOS 64-bit, it maybe is</li>
</ul>
<pre><code>/usr/java/jdk1.6.0_45/jre/lib/amd64/server/libjvm.so`;
</code></pre>
<ul>
<li>On CentOS 32-bit, it maybe is</li>
</ul>
<pre><code>/usr/java/jdk1.7.0_51/jre/lib/i386/server/libjvm.so`;
</code></pre>
<h2>
<a id="user-content-jvm_var" class="anchor" href="#jvm_var" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_var</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_var</strong> <em>name</em> <em>value</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines a varaible which can be reused in jvm related directives such as <a href="#user-content-jvm_var">jvm_var</a>, <a href="#user-content-jvm_classpath">jvm_classpath</a>, <a href="#user-content-jvm_options">jvm_options</a>.</p>
<p>e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_var</span> myRoot <span class="pl-s">'/opt/javalibs'</span>;
<span class="pl-k">jvm_var</span> myAgent <span class="pl-s">'#{myRoot}/agent.jar'</span>;
<span class="pl-k">jvm_classpath</span> <span class="pl-s">'#{myAgent}:/opt/anotherLibs/*'</span>;</pre></div>
<h2>
<a id="user-content-jvm_classpath" class="anchor" href="#jvm_classpath" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_classpath</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_classpath</strong> <em>classpaths</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>Defines class paths those are separated by "<code>:</code>" (Unix like OS) or "<code>;</code>" (Windows) . When '<code>/*</code>' is used after a directory path all files and direct sub-directories will be used as the jvm class path entries. e.g. If /opt/mylibs has below structure.</p>
<pre><code>/opt/mylibs/
-----------/a.jar
-----------/b.jar
-----------/c.zip     
-----------/classes   (direct sub-directory)
-----------/resources (direct sub-directory)
</code></pre>
<p>And we use below declaration.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_classpath</span> /opt/mylibs/*;
<span class="pl-c">## there are two equivalent declarations which use quote mark. It is useful when there are some special chars such as ' ', ';' etc.</span>
<span class="pl-c">## jvm_classpath '/opt/mylibs/*';</span>
<span class="pl-c">## jvm_classpath "/opt/mylibs/*";</span>
</pre></div>
<p>It is equivalent to</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_options</span> <span class="pl-s">'-Djava.class.path=/opt/mylibs/a.jar:/opt/mylibs/b.jar:/opt/mylibs/c.zip:/opt/mylibs/classes:/opt/mylibs/resources'</span></pre></div>
<p>We can also define serveral class paths by using separator <code>:</code> (UNIX like OS) or <code>;</code> (Windows), e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_classpath</span> /opt/mylibs/*:/opt/my-another-libs/*:/opt/my-resources;
<span class="pl-c">## for windows user</span>
<span class="pl-c"># jvm_classpath c:/mylibs/*;c:/my-another-libs/*;c:/my-resources;</span></pre></div>
<p><strong>Note that the behavior about wildcard <code>*</code> here is different from <code>-cp</code> or <code>-classpath</code> option
of jdk/jre java command where wildcard <code>*</code> only means jar files and non-jar files and sub-directories
won't be included.</strong></p>
<h2>
<a id="user-content-jvm_classpath_check" class="anchor" href="#jvm_classpath_check" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_classpath_check</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_classpath_check</strong> on | off;</li>
<li>
<strong>Default</strong>:	on</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>Enables/disables checking access permission of jvm classpath. Default is on.</p>
<h2>
<a id="user-content-jvm_options" class="anchor" href="#jvm_options" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_options</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_options</strong> <em>jvm-option</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one jvm option. e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-c">## set initial Java heap size</span>
<span class="pl-k">jvm_options</span> -Xms250m;

<span class="pl-c">## set maximum Java heap size</span>
<span class="pl-k">jvm_options</span> -Xmx1024m;

<span class="pl-c">## set java thread stack size</span>
<span class="pl-k">jvm_options</span> -Xss128k;

<span class="pl-c">## set java system property</span>
<span class="pl-k">jvm_options</span> -Djava.awt.headless=true;</pre></div>
<h2>
<a id="user-content-jvm_workers" class="anchor" href="#jvm_workers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_workers</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_var</strong> <em>threads-num</em>
</li>
<li>
<strong>Default</strong>:	0</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>Enables thread pool mode and defines the threads number of thread pool. Default is disabled.</p>
<h2>
<a id="user-content-jvm_handler_type" class="anchor" href="#jvm_handler_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_handler_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_handler_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>Defines the default handler type it will be inherited by child server/location/nested-location context and it will
be overwrited by directives such as content_handler_type, access_handler_type, and so on.
When we use jvm init handler/exit handler we must define it.</p>
<h2>
<a id="user-content-jvm_init_handler_name" class="anchor" href="#jvm_init_handler_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_init_handler_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_init_handler_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_handler_type</span> java;
<span class="pl-k">jvm_init_handler_name</span> com.foo.handlers.MyJvmInitHandler;

<span class="pl-c">## or for clojure</span>
<span class="pl-k">jvm_handler_type</span> clojure;
<span class="pl-k">jvm_init_handler_name</span> foo.core/my-jvm-init-handler;</pre></div>
<ul>
<li><strong>Java</strong></li>
</ul>
<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">com.foo.handlers</span>;

<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.NginxJavaRingHandler</span>;

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MyJvmInitHandler</span> <span class="pl-k">implements</span> <span class="pl-e">NginxJavaRingHandler</span> {
  <span class="pl-k">public</span> <span class="pl-k">Object</span>[] <span class="pl-en">invoke</span>(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> <span class="pl-v">fakeReq</span>) {
    <span class="pl-c"><span class="pl-c">//</span>do some initializing here</span>
  }
}
</pre></div>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-clojure"><pre>(<span class="pl-k">ns</span> <span class="pl-e">foo.core</span>)
(<span class="pl-k">defn</span> <span class="pl-e">my-jvm-init-handler</span>[_]
  <span class="pl-c"><span class="pl-c">;</span>;; do some initializing here </span>
 )</pre></div>
<h2>
<a id="user-content-jvm_init_handler_code" class="anchor" href="#jvm_init_handler_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_init_handler_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_init_handler_code</strong> <em>inline-init-handler-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
<li>
<strong>repeatable</strong> false</li>
</ul>
<p>e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_handler_type</span> clojure;
<span class="pl-k">jvm_init_handler_code</span> <span class="pl-s">'(fn[_]</span>
<span class="pl-s">                       (do-some-initialization-work)</span>
<span class="pl-s">                       nil)</span>
<span class="pl-s">'</span>;</pre></div>
<h2>
<a id="user-content-jvm_exit_handler_name" class="anchor" href="#jvm_exit_handler_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_exit_handler_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_exit_handler_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<h2>
<a id="user-content-jvm_exit_handler_code" class="anchor" href="#jvm_exit_handler_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jvm_exit_handler_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>jvm_exit_handler_code</strong> <em>inline-exit-handler-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
</ul>
<p>e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">jvm_handler_type</span> clojure;
<span class="pl-k">jvm_exit_handler_code</span> <span class="pl-s">'(fn[_]</span>
<span class="pl-s">                       (do-some-cleaning-work)</span>
<span class="pl-s">                       nil)</span>
<span class="pl-s">'</span>;</pre></div>
<h2>
<a id="user-content-handlers_lazy_init" class="anchor" href="#handlers_lazy_init" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>handlers_lazy_init</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>handlers_lazy_init</strong> on | off;</li>
<li>
<strong>Default</strong>:	off</li>
<li>
<strong>Context</strong>:	http, server, location</li>
</ul>
<p>When <code>handlers_lazy_init</code> is on the related handler instance won't be created until the first related request comes.
be inherited by child server/location/nested-location context.</p>
<h2>
<a id="user-content-auto_upgrade_ws" class="anchor" href="#auto_upgrade_ws" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>auto_upgrade_ws</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>auto_upgrade_ws</strong> on | off;</li>
<li>
<strong>Default</strong>:	off</li>
<li>
<strong>Context</strong>:	http, server, location</li>
</ul>
<p><code>auto_upgrade_ws on</code> is equivalent to</p>
<div class="highlight highlight-source-java"><pre><span class="pl-c"><span class="pl-c">//</span>NginxHttpServerChannel sc = r.hijack(true);</span>
		
<span class="pl-c"><span class="pl-c">//</span>If we use nginx directive `auto_upgrade_ws on;`, these three lines can be omitted.</span>
<span class="pl-k">if</span> (<span class="pl-k">!</span>sc<span class="pl-k">.</span>webSocketUpgrade(<span class="pl-c1">true</span>)) {
		<span class="pl-k">return</span> <span class="pl-c1">null</span>;
}</pre></div>
<h2>
<a id="user-content-content_handler_type" class="anchor" href="#content_handler_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>content_handler_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>content_handler_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	clojure</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<h2>
<a id="user-content-content_handler_name" class="anchor" href="#content_handler_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>content_handler_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>content_handler_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Defines an external content handler. e.g.</p>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-clojure"><pre>(<span class="pl-k">ns</span> <span class="pl-e">my.hello</span>)
(<span class="pl-k">defn</span> <span class="pl-e">hello-world</span> [request]
  {<span class="pl-c1">:status</span> <span class="pl-c1">200</span>
   <span class="pl-c1">:headers</span> {<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">"</span>text/plain<span class="pl-pds">"</span></span>}
   <span class="pl-c"><span class="pl-c">;</span>response body can be string, File or Array/Collection/Seq of them</span>
   <span class="pl-c1">:body</span> <span class="pl-s"><span class="pl-pds">"</span>Hello World<span class="pl-pds">"</span></span>})
</pre></div>
<p>Then we can reference it in nginx.conf</p>
<div class="highlight highlight-source-nginx"><pre>       <span class="pl-k">location</span> <span class="pl-en">/myClojure </span>{
          <span class="pl-k">content_handler_type</span> <span class="pl-s">'clojure'</span>;
          <span class="pl-k">content_handler_name</span> <span class="pl-s">'my.hello/hello-world'</span>;
       }</pre></div>
<ul>
<li><strong>Java</strong></li>
</ul>
<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">mytest</span>;
<span class="pl-k">import static</span> <span class="pl-smi">nginx.clojure.MiniConstants.*</span>;
<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.NginxJavaRingHandler</span>;

<span class="pl-k">import</span> <span class="pl-smi">java.util.HashMap</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.util.Map</span>;
<span class="pl-k">public</span>  <span class="pl-k">class</span> <span class="pl-en">Hello</span> <span class="pl-k">implements</span> <span class="pl-e">NginxJavaRingHandler</span> {

		<span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">Object</span>[] <span class="pl-en">invoke</span>(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-v">request</span>) {
			<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Object</span>[] { 
					<span class="pl-c1">NGX_HTTP_OK</span>, <span class="pl-c"><span class="pl-c">//</span>http status 200</span>
					<span class="pl-smi">ArrayMap</span><span class="pl-k">.</span>create(<span class="pl-c1">CONTENT_TYPE</span>, <span class="pl-s"><span class="pl-pds">"</span>text/plain<span class="pl-pds">"</span></span>), <span class="pl-c"><span class="pl-c">//</span>headers map</span>
					<span class="pl-s"><span class="pl-pds">"</span>Hello, Java &amp; Nginx!<span class="pl-pds">"</span></span>  <span class="pl-c"><span class="pl-c">//</span>response body can be string, File or Array/Collection of them</span>
					};
		}
	}</pre></div>
<p>In nginx.conf</p>
<div class="highlight highlight-source-nginx"><pre>       <span class="pl-k">location</span> <span class="pl-en">/myJava </span>{
          <span class="pl-k">content_handler_type</span> <span class="pl-s">'java'</span>;
          <span class="pl-k">content_handler_name</span> <span class="pl-s">'mytest.Hello'</span>;
       }</pre></div>
<ul>
<li><strong>Groovy</strong></li>
</ul>
<div class="highlight highlight-source-groovy"><pre>   <span class="pl-k">package</span> <span class="pl-smi">mytest</span>;
   <span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.NginxJavaRingHandler</span>;
   <span class="pl-k">import</span> <span class="pl-smi">java.util.Map</span>;
   <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">HelloGroovy</span> <span class="pl-k">implements</span> <span class="pl-e">NginxJavaRingHandler</span> {
      <span class="pl-k">public</span> <span class="pl-k">Object</span>[] <span class="pl-en">invoke</span>(<span class="pl-k">Map&lt;<span class="pl-k">String</span>, <span class="pl-k">Object</span>&gt;</span> <span class="pl-v">request</span>){
         <span class="pl-k">return</span> 
         [<span class="pl-c1">200</span>,  <span class="pl-c"><span class="pl-c">//</span>http status 200</span>
          [<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>text/html<span class="pl-pds">"</span></span>],<span class="pl-c"><span class="pl-c">//</span>headers map</span>
          <span class="pl-s"><span class="pl-pds">"</span>Hello, Groovy &amp; Nginx!<span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">//</span>response body can be string, File or Array/Collection of them</span>
          ]; 
      }
   }</pre></div>
<p>In nginx.conf</p>
<div class="highlight highlight-source-nginx"><pre>       <span class="pl-k">location</span> <span class="pl-en">/myJava </span>{
          <span class="pl-k">content_handler_type</span> <span class="pl-s">'groovy'</span>;
          <span class="pl-k">content_handler_name</span> <span class="pl-s">'mytest.HelloGroovy'</span>;
       }</pre></div>
<h2>
<a id="user-content-content_handler_code" class="anchor" href="#content_handler_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>content_handler_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>content_handler_code</strong> <em>inline-content-handler-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Defines an inline content handler. e.g.</p>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">location</span> <span class="pl-en">/hello </span>{
  <span class="pl-k">content_handler_type</span> clojure;
  <span class="pl-k">content_handler_code</span> <span class="pl-s">'</span>
<span class="pl-s">    (fn[r] {:status 200, {:content-type "text/plain"}, "Hello, Nginx &amp; Clojure!"} )</span>
<span class="pl-s">  '</span>;
}</pre></div>
<ul>
<li><strong>Groovy</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">location</span> <span class="pl-en">/groovy </span>{
    <span class="pl-k">content_handler_type</span> <span class="pl-s">'groovy'</span>;
    <span class="pl-k">content_handler_code</span> <span class="pl-s">' </span>
<span class="pl-s">         import nginx.clojure.java.NginxJavaRingHandler;</span>
<span class="pl-s">         import java.util.Map;</span>
<span class="pl-s">         public class HelloGroovy implements NginxJavaRingHandler {</span>
<span class="pl-s">            public Object[] invoke(Map&lt;String, Object&gt; request){</span>
<span class="pl-s">               return [200, //http status 200</span>
<span class="pl-s">                       ["Content-Type":"text/html"], //headers map</span>
<span class="pl-s">                       "Hello, Groovy &amp; Nginx!"]; //response body can be string, File or Array/Collection of them</span>
<span class="pl-s">            }</span>
<span class="pl-s">         }</span>
<span class="pl-s">    '</span>;
}</pre></div>
<h2>
<a id="user-content-content_handler_property" class="anchor" href="#content_handler_property" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>content_handler_property</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>content_handler_property</strong> name value;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one content handler property. All of those content handler properties belonged to one location will be pass to
the related content handler 's method <code>config(properties)</code> if the content handler implements
the interface <code>nginx.clojure.Configurable</code>.</p>
<h2>
<a id="user-content-rewrite_handler_type" class="anchor" href="#rewrite_handler_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>rewrite_handler_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>rewrite_handler_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	clojure</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<h2>
<a id="user-content-rewrite_handler_name" class="anchor" href="#rewrite_handler_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>rewrite_handler_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>rewrite_handler_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a rewrite handler by a full qualified name. A rewrite handler can be used to set Nginx variables or return errors before
<a href="https://www.nginx.com/resources/admin-guide/reverse-proxy/" rel="nofollow">proxy_pass</a> or content ring handler.
If the rewrite handler returns <code>phase-done</code> (Clojure) or  <code>PHASE_DONE</code> (Groovy/Java), nginx will continue to invoke proxy_pass or
content handler. Otherwise if the rewrite handler returns a general response, nginx will send this response to the client and
stop to continue to invoke proxy_pass or content handler.</p>
<blockquote>
<p><strong>Note:</strong>
All rewrite directives,  such as <code>rewrite</code>, <code>set</code>,  will be executed after the invocation rewrite handler even if
they are declared before nginx rewrtite handler.
So the below example maybe is wrong. For more details about Nginx Variable please check this<br>
<a href="http://openresty.org/download/agentzh-nginx-tutorials-en.html" rel="nofollow">nginx tutorial</a> which explains perfectly the variable scope.</p>
</blockquote>
<div class="highlight highlight-source-nginx"><pre>
    <span class="pl-k">location</span> <span class="pl-en">/myproxy </span>{
          <span class="pl-c">## It maybe is WRONG!!!</span>
          <span class="pl-c">## Because execution of directive `set` is after the execution of Nginx-Clojure rewrite handler</span>
          <span class="pl-k">set</span> <span class="pl-smi">$myhost</span> <span class="pl-s">""</span>;
          <span class="pl-k">rewrite_handler_type</span> clojure;
          <span class="pl-k">rewrite_handler_name</span> <span class="pl-s">'myns.handler/my-rewrite-handler'</span>;
          <span class="pl-k">proxy_pass</span> <span class="pl-smi">$myhost</span>
       }    
</pre></div>
<p>This example is right and there we declare variable $myhost at the outside of <code>location {</code> block.</p>
<div class="highlight highlight-source-nginx"><pre>
    <span class="pl-k">set</span> <span class="pl-smi">$myhost</span> <span class="pl-s">""</span>;
    <span class="pl-k">location</span> <span class="pl-en">/myproxy </span>{
      <span class="pl-k">rewrite_handler_type</span> <span class="pl-s">'clojure'</span>;
      <span class="pl-k">rewrite_handler_code</span> <span class="pl-s">'myns.handler/my-rewrite-handler'</span>;
      <span class="pl-k">proxy_pass</span> <span class="pl-smi">$myhost</span>;
    }    
</pre></div>
<div class="highlight highlight-source-clojure"><pre>(<span class="pl-k">ns</span> <span class="pl-e">myns.handler</span>
  (<span class="pl-c1">:require</span> [nginx.clojure.core <span class="pl-c1">:as</span> ncc]))
(<span class="pl-k">defn</span> <span class="pl-e">my-rewrite-handler</span>[req]
		<span class="pl-c"><span class="pl-c">;</span>compute myhost (upstream name or real host name) based req &amp; remote service, e.g.</span>
	  (<span class="pl-k">let</span> [myhost (<span class="pl-en">compute-myhost</span> req)])
			  (<span class="pl-en">ncc/set-ngx-var!</span> req <span class="pl-s"><span class="pl-pds">"</span>myhost<span class="pl-pds">"</span></span> myhost)
			  <span class="pl-e">ncc</span>/<span class="pl-e">phase-done</span>)</pre></div>
<h2>
<a id="user-content-rewrite_handler_code" class="anchor" href="#rewrite_handler_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>rewrite_handler_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>rewrite_handler_code</strong> <em>inline-rewrite-handler-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a rewrite handler by a block of inline code.</p>
<p>e.g.</p>
<div class="highlight highlight-source-nginx"><pre>
 <span class="pl-k">set</span> <span class="pl-smi">$myhost</span> <span class="pl-s">""</span>;
 <span class="pl-k">location</span> <span class="pl-en">/myproxy </span>{
    <span class="pl-k">rewrite_handler_type</span> <span class="pl-s">'clojure'</span>;
    <span class="pl-k">rewrite_handler_code</span> <span class="pl-s">'</span>
<span class="pl-s">     (do (use <span class="pl-cce">\'</span>[nginx.clojure.core]) </span>
<span class="pl-s">			(fn[req]</span>
<span class="pl-s">			  ;compute myhost (upstream name or real host name) based req &amp; remote service, e.g.</span>
<span class="pl-s">			  (let [myhost (compute-myhost req)])</span>
<span class="pl-s">			  (set-ngx-var! req "myhost" myhost)</span>
<span class="pl-s">			  phase-done))</span>
<span class="pl-s">    '</span>;
    <span class="pl-k">proxy_pass</span> <span class="pl-smi">$myhost</span>;
 } </pre></div>
<h2>
<a id="user-content-rewrite_handler_property" class="anchor" href="#rewrite_handler_property" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>rewrite_handler_property</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>rewrite_handler_property</strong> name value;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one rewrite handler property. All of those rewrite handler properties belonged to one location will be pass to
the related rewrite handler 's method <code>config(properties)</code> if the rewrite handler implements
the interface <code>nginx.clojure.Configurable</code>.</p>
<h2>
<a id="user-content-access_handler_type" class="anchor" href="#access_handler_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>access_handler_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>access_handler_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	clojure</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<h2>
<a id="user-content-access_handler_name" class="anchor" href="#access_handler_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>access_handler_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>access_handler_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Access handler runs after rewrite handler and before content handler (e.g. general ring handler,  proxy_pass, etc.).
Access handler has the same form with rewrite handle. When it returns <code>phase-done</code> (Clojure) or  <code>PHASE_DONE</code> (Groovy/Java)
, Nginx will continue the next phase otherwise nginx will response directly typically with some error information,
such as <code>401 Unauthorized</code>, <code>403 Forbidden</code>, etc.</p>
<p>Here 's an example to implement a simple HTTP Basic Authentication.</p>
<div class="highlight highlight-source-nginx"><pre>
          <span class="pl-k">location</span> <span class="pl-en">/basicAuth </span>{
               <span class="pl-k">access_handler_type</span> <span class="pl-s">'java'</span>;
	             <span class="pl-k">access_handler_name</span> <span class="pl-s">'my.BasicAuthHandler'</span>;
	             ....
	          }</pre></div>
<div class="highlight highlight-source-java"><pre>
	<span class="pl-c"><span class="pl-c">/**</span></span>
<span class="pl-c">	 * This is an  example of HTTP basic Authentication.</span>
<span class="pl-c">	 * It will require visitor to input a user name (xfeep) and password (hello!) </span>
<span class="pl-c">	 * otherwise it will return 401 Unauthorized or BAD USER &amp; PASSWORD </span>
<span class="pl-c">	 <span class="pl-c">*/</span></span>
	<span class="pl-k">public</span>  <span class="pl-k">class</span> <span class="pl-en">BasicAuthHandler</span> <span class="pl-k">implements</span> <span class="pl-e">NginxJavaRingHandler</span> {

		<span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">Object</span>[] <span class="pl-en">invoke</span>(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-v">request</span>) {
			<span class="pl-smi">String</span> auth <span class="pl-k">=</span> (<span class="pl-smi">String</span>) ((<span class="pl-smi">Map</span>)request<span class="pl-k">.</span>get(<span class="pl-c1">HEADERS</span>))<span class="pl-k">.</span>get(<span class="pl-s"><span class="pl-pds">"</span>authorization<span class="pl-pds">"</span></span>);
			<span class="pl-k">if</span> (auth <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
				<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Object</span>[] { <span class="pl-c1">401</span>, <span class="pl-smi">ArrayMap</span><span class="pl-k">.</span>create(<span class="pl-s"><span class="pl-pds">"</span>www-authenticate<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Basic realm=<span class="pl-cce">\"</span>Secure Area<span class="pl-cce">\"</span><span class="pl-pds">"</span></span>),
						<span class="pl-s"><span class="pl-pds">"</span>&lt;HTML&gt;&lt;BODY&gt;&lt;H1&gt;401 Unauthorized.&lt;/H1&gt;&lt;/BODY&gt;&lt;/HTML&gt;<span class="pl-pds">"</span></span> };
			}
			<span class="pl-k">String</span>[] up <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">String</span>(<span class="pl-smi">DatatypeConverter</span><span class="pl-k">.</span>parseBase64Binary(auth<span class="pl-k">.</span>substring(<span class="pl-s"><span class="pl-pds">"</span>Basic <span class="pl-pds">"</span></span><span class="pl-k">.</span>length())), <span class="pl-c1">DEFAULT_ENCODING</span>)<span class="pl-k">.</span>split(<span class="pl-s"><span class="pl-pds">"</span>:<span class="pl-pds">"</span></span>);
			<span class="pl-k">if</span> (up[<span class="pl-c1">0</span>]<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>xfeep<span class="pl-pds">"</span></span>) <span class="pl-k">&amp;&amp;</span> up[<span class="pl-c1">1</span>]<span class="pl-k">.</span>equals(<span class="pl-s"><span class="pl-pds">"</span>hello!<span class="pl-pds">"</span></span>)) {
				<span class="pl-k">return</span> <span class="pl-c1">PHASE_DONE</span>;
			}
			<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Object</span>[] { <span class="pl-c1">401</span>, <span class="pl-smi">ArrayMap</span><span class="pl-k">.</span>create(<span class="pl-s"><span class="pl-pds">"</span>www-authenticate<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Basic realm=<span class="pl-cce">\"</span>Secure Area<span class="pl-cce">\"</span><span class="pl-pds">"</span></span>),
			<span class="pl-s"><span class="pl-pds">"</span>&lt;HTML&gt;&lt;BODY&gt;&lt;H1&gt;401 Unauthorized BAD USER &amp; PASSWORD.&lt;/H1&gt;&lt;/BODY&gt;&lt;/HTML&gt;<span class="pl-pds">"</span></span> };
		} 
	}</pre></div>
<h2>
<a id="user-content-access_handler_code" class="anchor" href="#access_handler_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>access_handler_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>access_handler_code</strong> <em>inline-access-handler-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a access handler by a block of inline code. See <a href="#user-content-access_handler_name">access_handler_name</a>.</p>
<h2>
<a id="user-content-access_handler_property" class="anchor" href="#access_handler_property" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>access_handler_property</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>access_handler_property</strong> name value;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one access handler property. All of those access handler properties belonged to one location will be pass to
the related access handler 's method <code>config(properties)</code> if the access handler implements
the interface <code>nginx.clojure.Configurable</code>.</p>
<h2>
<a id="user-content-header_filter_type" class="anchor" href="#header_filter_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>header_filter_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>header_filter_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	clojure</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<h2>
<a id="user-content-header_filter_name" class="anchor" href="#header_filter_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>header_filter_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>header_filter_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a header filter by a full qualified name.</p>
<p>We can use header filter to do some useful things, e.g.</p>
<ol>
<li>monitor the time cost of requests processed</li>
<li>modify the response header dynamically</li>
<li>write user defined log</li>
</ol>
<p>Header filter has the same return form with rewrite handler/ access handler.
When it returns <code>phase-done</code> (Clojure) or  <code>PHASE_DONE</code> (Groovy/Java), Nginx will
continue the next phase otherwise Nginx will response directly typically with some error information.</p>
<p>This example will add more headers to the response.</p>
<ul>
<li><strong>Java/Groovy</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre>
      <span class="pl-k">location</span> <span class="pl-en">/javafilter </span>{
	          <span class="pl-k">header_filter_type</span> <span class="pl-s">'java'</span>;
	          <span class="pl-k">header_filter_name</span> <span class="pl-s">'my.AddMoreHeaders'</span>;
	           ..................
	          }</pre></div>
<div class="highlight highlight-source-java"><pre>
<span class="pl-k">package</span> <span class="pl-smi">my</span>;

<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.NginxJavaRingHandler</span>;
<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.Constants</span>;

	<span class="pl-k">public</span>  <span class="pl-k">class</span> <span class="pl-en">RemoveAndAddMoreHeaders</span> <span class="pl-k">implements</span> <span class="pl-e">NginxJavaHeaderFilter</span> {
		<span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">Object</span>[] <span class="pl-en">doFilter</span>(<span class="pl-k">int</span> <span class="pl-v">status</span>, <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-v">request</span>, <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-v">responseHeaders</span>) {
			responseHeaders<span class="pl-k">.</span>remove(<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>);
			responseHeaders<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>text/html<span class="pl-pds">"</span></span>);
			responseHeaders<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>Xfeep-Header<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Hello2!<span class="pl-pds">"</span></span>);
			responseHeaders<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>Server<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>My-Test-Server<span class="pl-pds">"</span></span>);
			<span class="pl-k">return</span> <span class="pl-smi">Constants</span><span class="pl-c1"><span class="pl-k">.</span>PHASE_DONE</span>;
		}
	}</pre></div>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre>
      <span class="pl-k">location</span> <span class="pl-en">/javafilter </span>{
	          <span class="pl-k">header_filter_type</span> <span class="pl-s">'clojure'</span>;
	          <span class="pl-k">header_filter_name</span> <span class="pl-s">'my/remove-and-add-more-headers'</span>;
	           ..................
	          }</pre></div>
<div class="highlight highlight-source-clojure"><pre>
(<span class="pl-k">ns</span> <span class="pl-e">my</span>
  (<span class="pl-c1">:use</span> [nginx.clojure.core])
  (<span class="pl-c1">:require</span>  [clj-http.client <span class="pl-c1">:as</span> client]))
  
(<span class="pl-k">defn</span> <span class="pl-e">remove-and-add-more-headers</span> 
[status request response-headers]
  (<span class="pl-en">dissoc!</span>  response-headers <span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>) 
  (<span class="pl-en">assoc!</span>  response-headers <span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>  <span class="pl-s"><span class="pl-pds">"</span>text/html<span class="pl-pds">"</span></span>)
  (<span class="pl-en">assoc!</span>  response-headers <span class="pl-s"><span class="pl-pds">"</span>Xfeep-Header<span class="pl-pds">"</span></span>  <span class="pl-s"><span class="pl-pds">"</span>Hello2!<span class="pl-pds">"</span></span>)
  (<span class="pl-en">assoc!</span>  response-headers <span class="pl-s"><span class="pl-pds">"</span>Server<span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">"</span>My-Test-Server<span class="pl-pds">"</span></span>) 
  <span class="pl-e">phase-done</span>)</pre></div>
<h2>
<a id="user-content-header_filter_code" class="anchor" href="#header_filter_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>header_filter_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>header_filter_code</strong> <em>inline-header-filter-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a header filter by a block of inline code. See <a href="#user-content-header_filter_name">header_filter_name</a>.</p>
<h2>
<a id="user-content-header_filter_property" class="anchor" href="#header_filter_property" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>header_filter_property</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>header_filter_property</strong> name value;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one header filter property. All of those header filter properties belonged to one location will be pass to
the related header filter 's method <code>config(properties)</code> if the header filter implements
the interface <code>nginx.clojure.Configurable</code>.</p>
<h2>
<a id="user-content-body_filter_type" class="anchor" href="#body_filter_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>body_filter_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>body_filter_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	clojure</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<h2>
<a id="user-content-body_filter_name" class="anchor" href="#body_filter_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>body_filter_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>body_filter_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a body filter by a full qualified name.</p>
<p>We can use body filter to modify/replace body content.</p>
<p>A stream faced Java body filter should implement the interface NginxJavaBodyFilter which has this method:</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">Object</span>[] doFilter(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> request, <span class="pl-smi">InputStream</span> bodyChunk, <span class="pl-k">boolean</span> isLast)  throws <span class="pl-smi">IOException</span>;</pre></div>
<p>For one request this method can be invoked multiple times and at the last time the argument
<code>isLast</code> will be true. Note that <code>bodyChunk</code> is valid only at its call scope and can
not be stored for later usage.
The result returned must be an array which has three elements viz. {status, headers, filtered_chunk}.
If <code>status</code> is not null <code>filtered_chunk</code> will be used as the final chunk. <code>status</code> and <code>headers</code> will
be ignored when the response headers has been sent already.
<code>filtered_chunk</code> can be either of</p>
<ol>
<li>File, viz. java.io.File</li>
<li>String</li>
<li>InputStream</li>
<li>Array/Iterable, e.g. Array/List/Set of above types</li>
</ol>
<p>A string faced Java body filter should extends the class StringFacedJavaBodyFilter which has one protected method to be overriden:</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">protected</span> <span class="pl-k">Object</span>[] doFilter(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> request, <span class="pl-smi">String</span> body, <span class="pl-k">boolean</span> isLast) throws <span class="pl-smi">IOException</span></pre></div>
<p>This method has the same return value with <code>NginxJavaBodyFilter.doFilter</code>.</p>
<p>This example will make to body content to upper case.</p>
<ul>
<li><strong>Java/Groovy</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre>
      <span class="pl-k">location</span> <span class="pl-en">/upperfilter </span>{
	          <span class="pl-k">body_filter_type</span> <span class="pl-s">'java'</span>;
	          <span class="pl-k">body_filter_name</span> <span class="pl-s">'my.UppercaseBodyFilter'</span>;
	           ..................
	          }</pre></div>
<div class="highlight highlight-source-java"><pre>
<span class="pl-k">package</span> <span class="pl-smi">my</span>;

<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.NginxJavaRingHandler</span>;
<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.Constants</span>;
<span class="pl-k">import</span> <span class="pl-smi">nginx.clojure.java.StringFacedJavaBodyFilter</span>;

<span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">UppercaseBodyFilter</span> <span class="pl-k">extends</span> <span class="pl-e">StringFacedJavaBodyFilter</span> {
		<span class="pl-k">@Override</span>
		<span class="pl-k">protected</span> <span class="pl-k">Object</span>[] <span class="pl-en">doFilter</span>(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-v">request</span>, <span class="pl-smi">String</span> <span class="pl-v">body</span>, <span class="pl-k">boolean</span> <span class="pl-v">isLast</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span> {
			<span class="pl-k">if</span> (isLast) {
				<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Object</span>[] {<span class="pl-c1">200</span>, <span class="pl-c1">null</span>, body<span class="pl-k">.</span>toUpperCase()};
			}<span class="pl-k">else</span> {
				<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Object</span>[] {<span class="pl-c1">null</span>, <span class="pl-c1">null</span>, body<span class="pl-k">.</span>toUpperCase()};
			}
		}
	}</pre></div>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre>
      <span class="pl-k">location</span> <span class="pl-en">/upperfilter </span>{
	          <span class="pl-k">body_filter_type</span> <span class="pl-s">'clojure'</span>;
	          <span class="pl-k">body_filter_name</span> <span class="pl-s">'my/uppercase-filter'</span>;
	           ..................
	          }</pre></div>
<div class="highlight highlight-source-clojure"><pre>
(<span class="pl-k">defn</span> <span class="pl-e">uppercase-filter</span> [request body-chunk last?]
  (<span class="pl-k">let</span> [upper-body (<span class="pl-en">.toUpperCase</span> body-chunk)]
      (<span class="pl-k">if</span> last? {<span class="pl-c1">:status</span> <span class="pl-c1">200</span> <span class="pl-c1">:body</span> upper-body}
        {<span class="pl-c1">:body</span> upper-body})))</pre></div>
<h2>
<a id="user-content-body_filter_code" class="anchor" href="#body_filter_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>body_filter_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>body_filter_code</strong> <em>inline-body-filter-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Specifies a header filter by a block of inline code. See <a href="#user-content-body_filter_name">body_filter_name</a>.</p>
<h2>
<a id="user-content-body_filter_property" class="anchor" href="#body_filter_property" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>body_filter_property</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>body_filter_property</strong> name value;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one body filter property. All of those body filter properties belonged to one location will be pass to
the related body filter 's method <code>config(properties)</code> if the body filter implements
the interface <code>nginx.clojure.Configurable</code>.</p>
<h2>
<a id="user-content-log_handler_type" class="anchor" href="#log_handler_type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>log_handler_type</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>log_handler_type</strong> clojure | java | groovy;</li>
<li>
<strong>Default</strong>:	clojure</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<h2>
<a id="user-content-log_handler_name" class="anchor" href="#log_handler_name" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>log_handler_name</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>log_handler_name</strong> <em>full-qualified-name</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Defines an external log handler. e.g.</p>
<p>Nginx log handler will be called just before the request is destroyed and its return result will be ignored.
In a log handler we should not modify any thing about this request such as header, status. response, body and so on.</p>
<p>e.g. we can write access log just like</p>
<pre><code>127.0.0.1 - x 26/Oct/2019:13:54:08 +0800 GET /cljloghandler/simpleloghandler HTTP/1.1 200 20 x curl/7.64.0 
127.0.0.1 - x 26/Oct/2019:14:44:57 +0800 GET /cljloghandler/simpleloghandler HTTP/1.1 200 20 x curl/7.64.0 
127.0.0.1 - x 26/Oct/2019:14:59:03 +0800 GET //cljloghandler/simpleloghandler HTTP/1.1 200 20 x Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36 

</code></pre>
<ul>
<li><strong>Java</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">location</span> <span class="pl-en">/hello </span>{
  ....
  <span class="pl-k">log_handler_type</span> java;
  <span class="pl-k">log_handler_name</span> mytest.MyLogHandler;
  <span class="pl-k">log_handler_property</span> logUserAgent<span class="pl-c1"> on</span>;
}
</pre></div>
<div class="highlight highlight-source-java"><pre>	<span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">SimpleLogHandler</span> <span class="pl-k">implements</span> <span class="pl-e">NginxJavaRingHandler</span>, <span class="pl-e">Configurable</span> {
		
		<span class="pl-k">boolean</span> logUserAgent;
		
		<span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">Object</span>[] <span class="pl-en">invoke</span>(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-v">request</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span> {
			<span class="pl-smi">File</span> file <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">File</span>(<span class="pl-s"><span class="pl-pds">"</span>logs/SimpleLogHandler.log<span class="pl-pds">"</span></span>);
			<span class="pl-smi">NginxJavaRequest</span> r <span class="pl-k">=</span> (<span class="pl-smi">NginxJavaRequest</span>) request;
			<span class="pl-k">try</span> (<span class="pl-smi">FileOutputStream</span> out <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">FileOutputStream</span>(file, <span class="pl-c1">true</span>)) {
				<span class="pl-smi">String</span> msg <span class="pl-k">=</span> <span class="pl-smi">String</span><span class="pl-k">.</span>format(<span class="pl-s"><span class="pl-pds">"</span>%s - %s [%s] <span class="pl-cce">\"</span>%s<span class="pl-cce">\"</span> %s <span class="pl-cce">\"</span>%s<span class="pl-cce">\"</span> %s %s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>remote_addr<span class="pl-pds">"</span></span>),
						r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>remote_user<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>), r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>time_local<span class="pl-pds">"</span></span>), r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>request<span class="pl-pds">"</span></span>),
						r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>status<span class="pl-pds">"</span></span>), r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>body_bytes_sent<span class="pl-pds">"</span></span>), r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>http_referer<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>),
						logUserAgent <span class="pl-k">?</span> r<span class="pl-k">.</span>getVariable(<span class="pl-s"><span class="pl-pds">"</span>http_user_agent<span class="pl-pds">"</span></span>) <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>-<span class="pl-pds">"</span></span>);
				out<span class="pl-k">.</span>write(msg<span class="pl-k">.</span>getBytes(<span class="pl-s"><span class="pl-pds">"</span>utf8<span class="pl-pds">"</span></span>));
			}
			<span class="pl-k">return</span> <span class="pl-c1">null</span>;
		}

		<span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">config</span>(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> <span class="pl-v">properties</span>) {
			logUserAgent <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>on<span class="pl-pds">"</span></span><span class="pl-k">.</span>equalsIgnoreCase(properties<span class="pl-k">.</span>get(<span class="pl-s"><span class="pl-pds">"</span>logUserAgent<span class="pl-pds">"</span></span>));
		}
		

		<span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">String</span>[] <span class="pl-en">variablesNeedPrefetch</span>() {
			<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">String</span>[] { <span class="pl-s"><span class="pl-pds">"</span>remote_addr<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>remote_user<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>time_local<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>request<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>status<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>body_bytes_sent<span class="pl-pds">"</span></span>,
					<span class="pl-s"><span class="pl-pds">"</span>http_referer<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>http_user_agent<span class="pl-pds">"</span></span> };
		}
	}</pre></div>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">location</span> <span class="pl-en">/hello </span>{
  <span class="pl-k">log_handler_type</span> clojure;
  <span class="pl-k">log_handler_name</span> mytest/simple-log-handler;
}
</pre></div>
<div class="highlight highlight-source-clojure"><pre>(<span class="pl-k">ns</span> <span class="pl-e">mytest</span>
  (<span class="pl-c1">:use</span> [nginx.clojure.core]))

(<span class="pl-k">defn</span> <span class="pl-e">simple-log-handler</span>
  [r]
    (<span class="pl-en">spit</span> <span class="pl-s"><span class="pl-pds">"</span>logs/SimpleLogHandler.log<span class="pl-pds">"</span></span> 
          (<span class="pl-en">str</span> (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>remote_addr<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> - <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>remote_user<span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>time_local<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>request<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>status<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>body_bytes_sent<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>http_referer<span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
               (<span class="pl-en">get-ngx-var</span> r <span class="pl-s"><span class="pl-pds">"</span>http_user_agent<span class="pl-pds">"</span></span>) <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>
                <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>)
          <span class="pl-c1">:append</span> <span class="pl-c1">true</span> ))

<span class="pl-c"><span class="pl-c">;</span>;; make variables prefetched to access them at non-main thread</span>
(<span class="pl-k">def</span> <span class="pl-e">simple-log-handler</span> (<span class="pl-en">with-meta</span> simple-log-handler {<span class="pl-s"><span class="pl-pds">"</span>variablesNeedPrefetch<span class="pl-pds">"</span></span> 
                                        [<span class="pl-s"><span class="pl-pds">"</span>remote_addr<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>remote_user<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>time_local<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>request<span class="pl-pds">"</span></span>, 
                                         <span class="pl-s"><span class="pl-pds">"</span>status<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>body_bytes_sent<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>http_referer<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>http_user_agent<span class="pl-pds">"</span></span>]}))</pre></div>
<h2>
<a id="user-content-log_handler_code" class="anchor" href="#log_handler_code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>log_handler_code</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>log_handler_code</strong> <em>log-content-handler-code</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>Defines an inline content handler. e.g.</p>
<ul>
<li><strong>Clojure</strong></li>
</ul>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">location</span> <span class="pl-en">/hello </span>{
  <span class="pl-k">log_handler_type</span> clojure;
  <span class="pl-k">log_handler_code</span> <span class="pl-s">'</span>
<span class="pl-s">    (fn[r] (spit "logs/SimpleLogHandler.log" (str (Date.) ":" (:uri r) "\n") :append true ) )</span>
<span class="pl-s">  '</span>;
}</pre></div>
<h2>
<a id="user-content-log_handler_property" class="anchor" href="#log_handler_property" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>log_handler_property</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>log_handler_property</strong> name value;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	location</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Defines one log handler property. All of those log handler properties belonged to one location will be pass to
the related log handler 's method <code>config(properties)</code> if the log handler implements
the interface <code>nginx.clojure.Configurable</code>.</p>
<h2>
<a id="user-content-always_read_body" class="anchor" href="#always_read_body" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>always_read_body</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>always_read_body</strong> on | off;</li>
<li>
<strong>Default</strong>:	off</li>
<li>
<strong>Context</strong>:	http, server, location</li>
</ul>
<p>By default request body will not be read until invoke content handler.
We can try <code>always_read_body on;</code> where we want to access the request body in a Java rewrite handler.
It can be inherited by child server/location/nested-location context.</p>
<p>e.g.</p>
<div class="highlight highlight-source-nginx"><pre>   <span class="pl-k">set</span> <span class="pl-smi">$myup</span> <span class="pl-s">""</span>;

   <span class="pl-k">location</span> <span class="pl-en">/readBodyProxy </span>{
      <span class="pl-k">always_read_body</span> on;
      <span class="pl-k">rewrite_handler_type</span> <span class="pl-s">'java'</span>;
      <span class="pl-k">rewrite_handler_name</span> <span class="pl-s">'my.SimpleRewriteByBodyHandler'</span>;
      <span class="pl-k">proxy_pass</span> http://<span class="pl-smi">$myup</span>;
   }</pre></div>
<p>Then we can get the request body in SimpleRewriteByBodyHandler.invoke.</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">@Override</span>
		<span class="pl-k">public</span> <span class="pl-k">Object</span>[] invoke(<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> request) {
			<span class="pl-smi">NginxJavaRequest</span> req <span class="pl-k">=</span> (<span class="pl-smi">NginxJavaRequest</span>) request;
			<span class="pl-smi">InputStream</span> in <span class="pl-k">=</span> (<span class="pl-smi">InputStream</span>) req<span class="pl-k">.</span>get(<span class="pl-smi">Constants</span><span class="pl-c1"><span class="pl-k">.</span>BODY</span>);
			<span class="pl-k">if</span> (in <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
			  <span class="pl-c"><span class="pl-c">//</span>...</span>
			}
		}</pre></div>
<h2>
<a id="user-content-shared_map" class="anchor" href="#shared_map" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>shared_map</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>shared_map</strong> <em>name type?arg1=val1&amp;arg2=val2...</em>;</li>
<li>
<strong>Default</strong>:	—</li>
<li>
<strong>Context</strong>:	http</li>
<li>
<strong>repeatable</strong> true</li>
</ul>
<p>Shared map is used to share data among nginx worker processes without any other external services
(e.g. redis, memorycached ) or libraries (e.g. SharedHashMap/Chronicle-Map, nginx lua shared dic).
So far it has two implementations: tiny map &amp; hash map both of which use MurmurHash3 32-bit to
generate hash code. The key/value of shared hash map can be <code>int</code>,<code>long</code>,<code>String</code>, <code>byte array</code>.</p>
<p><strong>limitation</strong></p>
<p>But note that if needed memory size is less than half of OS page size the real allocated size of nginx slab only can be
2^3 = 8, 2^4 = 16, 2^5 = 32,..., 2^(ngx_pagesize_shift - 1).So on 64-bit OS entry structure size of tiny map really
uses 32Bytes hash map uses 64Bytes. We'll do some optimize work in the future versions.</p>
<p>Neither tiny map nor hash map will rehash entries because both of them will have a constant number of buckets once they are initialized.</p>
<pre><code>${number of buckets}  =  round_up_to_power_of_2( ${entries} * 0.75 ) 
</code></pre>
<p><strong>Optimization for int/long</strong></p>
<p>Some optimization have been done about java int/long key/value, int/long key/value and they won't allocate additional memory
because them are stored in the entry structure itself.
e.g. in a hash map for a java long key (64bits) we will store it into</p>
<ol>
<li>entry.key (64-bit OS) or</li>
<li>entry.key &amp; entry.ksize (32-bit OS) because size of java long is constant we can reuse entry.ksize.</li>
</ol>
<p>viz. use c code</p>
<div class="highlight highlight-source-c"><pre>
*((<span class="pl-c1">uint64_t</span> *)(<span class="pl-k">void</span>*)&amp;entry-&gt;key) = ${64bits java <span class="pl-k">long</span> value};
</pre></div>
<p><strong>Example</strong></p>
<p>Here's an example to use shared map to count uri access times.</p>
<p>In nginx.conf</p>
<div class="highlight highlight-source-nginx"><pre>    <span class="pl-k">shared_map</span> uri_access_counters  tinymap?space=1m&amp;entries=8096;</pre></div>
<ul>
<li><strong>clojure</strong></li>
</ul>
<div class="highlight highlight-source-clojure"><pre>
<span class="pl-c"><span class="pl-c">;</span>; be friendly to embeded nginx-clojure where we maybe def shared map before server starts</span>
(<span class="pl-k">def</span> <span class="pl-e">dsmap</span> (<span class="pl-en">delay</span> (<span class="pl-en">nginx.clojure.clj.ClojureSharedHashMap.</span> <span class="pl-s"><span class="pl-pds">"</span>uri_access_counters<span class="pl-pds">"</span></span>)))

<span class="pl-c"><span class="pl-c">;</span>; if uri not exists set 1 otherwise increase its count.</span>
(<span class="pl-k">when</span> (<span class="pl-en">zero?</span> (<span class="pl-en">.putIntIfAbsent</span> @dsmap uri (<span class="pl-en">int</span> <span class="pl-c1">1</span>)))
  (<span class="pl-en">.atomicAddInt</span> @dsmap uri (<span class="pl-en">int</span> <span class="pl-c1">1</span>)))</pre></div>
<ul>
<li><strong>Java</strong></li>
</ul>
<div class="highlight highlight-source-java"><pre><span class="pl-c"><span class="pl-c">//</span> get the shared map. Mostly we do this in a handler</span>
<span class="pl-c"><span class="pl-c">//</span> (e.g. jvm init handler, content handler) 's constructor.</span>
<span class="pl-smi">NginxSharedHashMap</span> smap <span class="pl-k">=</span> <span class="pl-smi">NginxSharedHashMap</span><span class="pl-k">.</span>build(<span class="pl-s"><span class="pl-pds">"</span>uri_access_counters<span class="pl-pds">"</span></span>);

<span class="pl-c"><span class="pl-c">//</span>if uri not exists set 1 otherwise increase its count.</span>
<span class="pl-c"><span class="pl-c">//</span>putIntIfAbsent is a faster version of putIfAbsent for int value</span>
<span class="pl-k">if</span> (smap<span class="pl-k">.</span>putIntIfAbsent(uri, <span class="pl-c1">1</span>) <span class="pl-k">!=</span> <span class="pl-c1">0</span>) {
  smap<span class="pl-k">.</span>atomicAddInt(uri, <span class="pl-c1">1</span>);
}</pre></div>
<h2>
<a id="user-content-write_page_size" class="anchor" href="#write_page_size" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>write_page_size</h2>
<ul>
<li>
<strong>Syntax</strong>:	<strong>write_page_size</strong> <em>size</em>;</li>
<li>
<strong>Default</strong>:	4k</li>
<li>
<strong>Context</strong>:	location</li>
</ul>
<p>When using http server channel if our response is very small we can set a smaller write page size for better
performance. e.g.</p>
<div class="highlight highlight-source-nginx"><pre><span class="pl-k">location</span> <span class="pl-en">/small </span>{
   <span class="pl-k">write_page_size</span> 1k;
   ...
}</pre></div>

        </section>
    </div>
 <div id="footer">
    <!-- FOOTER  -->
	<div id="footer_wrap" class="outer">
		<footer class="inner">
			<p>
				Powered by <a href="http://getbootstrap.com/">Twitter Bootstrap</a>
			</p>
		</footer>
	</div>
 </div>
	<script type="text/javascript">
	  //$("a[href^='http']").attr("target","_blank");
	  //setTimeout("fixNavbarIssue();", 1000);
	</script>
</body>
  </html>