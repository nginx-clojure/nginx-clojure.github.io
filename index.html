<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="nginx-clojure.github.io : Nginx module for embedding Clojure / Java / Groovy programs, typically those Ring based handlers">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>nginx-clojure.github.io</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/nginx-clojure/nginx-clojure">View on GitHub</a>
          
          <h1 id="project_title">nginx-clojure
          </h1>
          <h2 id="project_tagline">Nginx module for embedding Clojure / Java / Groovy programs, typically those Ring based handlers</h2>
          <ul class="social-buttons">
	          <li>
	            <iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=nginx-clojure&repo=nginx-clojure&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="102px" height="20px"></iframe>
	          </li>
	          <li>
	            <iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=nginx-clojure&repo=nginx-clojure&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="100px" height="20px"></iframe>
	          </li>
	        </ul>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p><img src="https://github.com/nginx-clojure/nginx-clojure/raw/master/logo.png" alt="Alt text">Nginx-Clojure is a <a href="http://nginx.org/">Nginx</a> module for embedding Clojure or Java or Groovy programs, typically those <a href="https://github.com/ring-clojure/ring/blob/master/SPEC">Ring</a> based handlers.</p>

<p>There are some core features :</p>

<ol>
<li>Compatible with <a href="https://github.com/ring-clojure/ring/blob/master/SPEC">Ring</a> and obviously supports those Ring based frameworks, such as Compojure etc.</li>
<li>Use Clojure / Java / Groovy(<strong><em>NEW</em></strong> ) to write simple ring handlers for http services.</li>
<li>Use Clojure / Java / Groovy(<strong><em>NEW</em></strong> ) to write a simple nginx rewrite handler to set var or return errors before proxy pass or content ring handler</li>
<li>Non-blocking coroutine based socket which is Compatible with Java Socket API and works well with largely existing java library such as apache http client, mysql jdbc drivers. 
With this feature  one java main thread can handle thousands of connections.</li>
<li>Handle multiple sockets parallel in sub coroutines, e.g. we can invoke two remote services at the same time feature</li>
<li>Asynchronous callback API of socket for some advanced usage</li>
<li>Run initialization clojure code when nginx worker starting</li>
<li>Support user defined http request method</li>
<li>Compatible with the Nginx lastest stable version 1.6.0. (Nginx 1.4.x is also ok, older version is not tested and maybe works.)</li>
<li>One of  benifits of <a href="http://nginx.org/">Nginx</a> is worker processes are automatically restarted by a master process if they crash</li>
<li>Utilizes lazy headers and direct memory operation between <a href="http://nginx.org/">Nginx</a> and JVM to fast handle dynamic contents from Clojure or Java code.</li>
<li>Utilizes <a href="http://nginx.org/">Nginx</a> zero copy file sending mechanism to fast handle static contents controlled by Clojure or Java code.</li>
<li>Supports Linux x64, Linux x86 32bit, Win32 and Mac OS X. Win64 users can also run it with a 32bit JRE/JDK.</li>
</ol><p>By the way it is very fast, the benchmarks can be found <a href="https://github.com/ptaoussanis/clojure-web-server-benchmarks">HERE</a> .</p>

<h1>
<a name="1-installation" class="anchor" href="#1-installation"><span class="octicon octicon-link"></span></a>1. Installation</h1>

<p>The lastest release is 0.2.4. Please check the  <a href="HISTORY.md">Update History</a> for more details.</p>

<h2>
<a name="11-installation-by-binary" class="anchor" href="#11-installation-by-binary"><span class="octicon octicon-link"></span></a>1.1 Installation by Binary</h2>

<ol>
<li>First you can download  Release 0.2.4  from <a href="https://sourceforge.net/projects/nginx-clojure/files/">here</a>. 
The zip file includes Nginx-Clojure binaries about Linux x64, Linux i586, Win32 and Mac OS X.</li>
<li>Unzip the zip file downloaded then rename the file <code>nginx-${os-arc}</code> to <code>nginx</code>, eg. for linux is <code>nginx-linux-x64</code>
</li>
</ol><h2>
<a name="12-installation-by-source" class="anchor" href="#12-installation-by-source"><span class="octicon octicon-link"></span></a>1.2 Installation by Source</h2>

<p>Nginx-Clojure may be compiled successfully on Linux x64, Linux x86 32bit, Win32 and Mac OS X x64.</p>

<ol>
<li>First download from <a href="http://nginx.org/en/download.html">nginx site</a> or check out nginx source by hg from <a href="http://hg.nginx.org/nginx">http://hg.nginx.org/nginx</a>. 
For Win32 users MUST check out nginx source by hg because the zipped source doesn't contain Win32 related code.</li>
<li>Check out Nginx-Clojure source from github OR download the zipped source code from <a href="https://github.com/xfeep/nginx-clojure/releases">https://github.com/xfeep/nginx-clojure/releases</a>
</li>
<li>If you want to use Http SSL module, you should install openssl and openssl dev first.</li>
<li>
<p>Setting Java header include path in nginx-clojure/src/c/config</p>

<div class="highlight highlight-nginx"><pre><span class="c1">#eg. on ubuntu</span>
<span class="k">JNI_HEADER_1="/usr/lib/jvm/java-7-oracle/include"</span>
<span class="s">JNI_HEADER_2="</span><span class="nv">${JNI_HEADER_1}/linux"</span>
</pre></div>
</li>
<li>
<p>Add Nginx-Clojure module to Nginx configure command, here is a simplest example without more details about <a href="http://wiki.nginx.org/InstallOptions">InstallOptions</a></p>

<div class="highlight highlight-bash"><pre><span class="c">#If nginx source is checked out from hg, please replace ./configure with auto/configure</span>
<span class="nv">$.</span>/configure <span class="se">\</span>
    --add-module<span class="o">=</span>nginx-clojure/src/c
<span class="nv">$ </span>make
<span class="nv">$ </span>make install
</pre></div>
</li>
<li>
<p>Create the jar file about Nginx-Clojure</p>

<p>Please check the lein version <code>lein version</code>, it should be at least 2.0.0.</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span><span class="nb">cd </span>nginx-clojure
<span class="nv">$ </span>lein jar
</pre></div>

<p>Then you'll find nginx-clojure-${version}.jar (eg. nginx-clojure-0.2.4.jar) in the target folder. 
The jar file is self contained. If your project use clojure  it naturally depends on the clojure core jar, e.g clojure-1.5.1.jar.
If your project use groovy it naturally depends on the groovy runtime jar, e.g. groovy-2.3.4.jar.</p>
</li>
</ol><h1>
<a name="2-configurations" class="anchor" href="#2-configurations"><span class="octicon octicon-link"></span></a>2. Configurations</h1>

<h2>
<a name="21-jvm-path--class-path--other-jvm-options" class="anchor" href="#21-jvm-path--class-path--other-jvm-options"><span class="octicon octicon-link"></span></a>2.1 JVM Path , Class Path &amp; Other JVM Options</h2>

<p>Setting JVM path and class path within <code>http {</code> block in  nginx.conf</p>

<div class="highlight highlight-nginx"><pre>
    <span class="c1">#for win32,  jvm_path maybe is "C:/Program Files/Java/jdk1.7.0_25/jre/bin/server/jvm.dll";</span>
    <span class="c1">#for macosx, jvm_path maybe is "/Library/Java/JavaVirtualMachines/1.6.0_65-b14-462.jdk/Contents/Libraries/libserver.dylib";</span>
    <span class="c1">#for ubuntu, jvm_path maybe is "/usr/lib/jvm/java-7-oracle/jre/lib/amd64/server/libjvm.so";</span>
    <span class="c1">#for centos, jvm_path maybe is "/usr/java/jdk1.6.0_45/jre/lib/amd64/server/libjvm.so";</span>
    <span class="c1">#for centos 32bit, jvm_path maybe is "/usr/java/jdk1.7.0_51/jre/lib/i386/server/libjvm.so";</span>

    <span class="k">jvm_path</span> <span class="s">"/usr/lib/jvm/java-7-oracle/jre/lib/amd64/server/libjvm.so"</span><span class="p">;</span>

    <span class="c1">#jvm_options can be repeated once per option.</span>
    <span class="c1">#for clojure, you should append clojure core jar, e.g -Djava.class.path=jars/nginx-clojure-0.2.4.jar:mypath-xxx/clojure-1.5.1.jar,please  replace ':' with ';' on windows</span>
    <span class="c1">#for groovy, you should append groovy runtime jar, e.g. -Djava.class.path=jars/nginx-clojure-0.2.4.jar:mypath-xxx/groovy-2.3.4.jar, please replace ':' with ';' on windows</span>
    <span class="k">jvm_options</span> <span class="s">"-Djava.class.path=jars/nginx-clojure-0.2.4.jar"</span><span class="p">;</span>

    <span class="c1">#jvm heap memory</span>
    <span class="k">jvm_options</span> <span class="s">"-Xms1024m"</span><span class="p">;</span>
    <span class="k">jvm_options</span> <span class="s">"-Xmx1024m"</span><span class="p">;</span>

    <span class="c1">#for enable java remote debug uncomment next two lines, make sure "master_process = off;" or "worker_processes = 1;"</span>
    <span class="c1">#jvm_options "-Xdebug";</span>
    <span class="c1">#jvm_options "-Xrunjdwp:server=y,transport=dt_socket,address=8400,suspend=n";</span>
</pre></div>

<h3>
<a name="some-useful-tips" class="anchor" href="#some-useful-tips"><span class="octicon octicon-link"></span></a>Some Useful Tips</h3>

<p>These tips are really useful. Most of them are from real users. Thanks <a href="https://github.com/rickr-nook">Rickr Nook</a> who give us some useful tips.</p>

<ol>
<li>When importing Swing We Must specifiy <code>jvm_options "-Djava.awt.headless=true"</code> , otherwise the nginx will hang.</li>
<li>By adding the location of your clojure source files to the classpath,then just issue "nginx -s reload" and changes to the sources get picked up!</li>
<li>You can remove clojure-1.5.1.jar from class path and point at your "lein uberjar" to pick up a different version of clojure. </li>
<li>To use Java 7 on OSX, in nginx.conf your may set <code>jvm_path "/Library/Java/JavaVirtualMachines/jdk1.7.0_55.jdk/Contents/Home/jre/lib/server/libjvm.dylib";</code>
</li>
</ol><h2>
<a name="22-initialization-handler-for-nginx-worker" class="anchor" href="#22-initialization-handler-for-nginx-worker"><span class="octicon octicon-link"></span></a>2.2 Initialization Handler for nginx worker</h2>

<p>You can embed clojure/groovy code in the <code>http {</code> block to do initialization when nginx worker starting. e.g</p>

<div class="highlight highlight-nginx"><pre><span class="k">http</span> <span class="p">{</span>
<span class="kn">......</span>
    <span class="s">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span> <span class="c1"># or handler_type 'groovy'</span>
    <span class="kn">handler_code</span> <span class="s">'....'</span><span class="p">;</span>  <span class="c1">#the same with Ring Handler for Location (details in next section)</span>
<span class="kn">....</span>
<span class="err">}</span>
</pre></div>

<p>Or you can reference an exteranl clojure/java/groovy ring handler for initialization when nginx worker starting.</p>

<div class="highlight highlight-nginx"><pre><span class="k">http</span> <span class="p">{</span>
<span class="kn">......</span>
    <span class="s">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span> <span class="c1"># or handler_type 'java' / handler_type 'groovy'</span>
    <span class="kn">handler_name</span> <span class="s">'my.test/InitHandler'</span><span class="p">;</span>  <span class="c1"># or for java it maybe 'my.test.MyJavaInitHandler'</span>
<span class="kn">....</span>
<span class="err">}</span>
</pre></div>

<p>The ring handler can use status 500 and body to report some errors or just return nothing.
For more detail example of ring handler please see the next secion.</p>

<p>Please Keep these in your mind:</p>

<ul>
<li>By default if the initialization failed the nginx won't start successfully and the worker will exit after reporting an error message in error log file but the master keep running and take the port.</li>
<li>Because the maybe more than one nginx worker processes, so this code will run everytime per worker starting. </li>
<li>If you use <a href="https://github.com/OpenHFT/HugeCollections/wiki/Getting-Started">SharedHashMap</a>  to share data 
among nginx worker processes, Java file lock can be used to let only one nginx worker process do the initialization.</li>
<li>If you enabled <a href="#">coroutine support</a>, nginx maybe will start successfully even if your initialization failed after some socket operations. If you case it, you can 
use <code>nginx.clojure.core/without-coroutine</code> to wrap your handler, e.g.</li>
</ul><p>For clojure</p>

<div class="highlight highlight-nginx"><pre>        <span class="k">handler_code</span> <span class="s">'</span>
        <span class="s">(do</span>
            <span class="s">(use</span> <span class="s">\'nginx.clojure.core)</span>
            <span class="s">(without-coroutine</span>
              <span class="s">(fn[ctx]</span>
                <span class="s">....</span>
                <span class="s">)</span>
            <span class="s">))</span>
        <span class="s">'</span><span class="p">;</span>
</pre></div>

<h2>
<a name="23-ring-handler-for-location" class="anchor" href="#23-ring-handler-for-location"><span class="octicon octicon-link"></span></a>2.3 Ring Handler for Location</h2>

<p>Within <code>location</code> block, </p>

<ul>
<li>Directive <code>handler_type</code> is used to setting a type of handler.</li>
<li>Directive <code>handler_code</code> is used to setting an inline Ring handler.</li>
<li>Directive <code>handler_name</code> is used to setting an external Ring handler which is in a certain jar file included by your classpath.</li>
</ul><h3>
<a name="231-inline-ring-handler" class="anchor" href="#231-inline-ring-handler"><span class="octicon octicon-link"></span></a>2.3.1 Inline Ring Handler</h3>

<p>For Clojure : </p>

<div class="highlight highlight-nginx"><pre>       <span class="k">location</span> <span class="s">/clojure</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span>
          <span class="kn">handler_code</span> <span class="s">'</span> 
                        <span class="s">(fn[req]</span>
                          <span class="p">{</span>
                            <span class="kn">:status</span> <span class="mi">200</span><span class="s">,</span>
                            <span class="p">:</span><span class="s">headers</span> <span class="p">{</span><span class="kn">"content-type"</span> <span class="s">"text/plain"</span><span class="err">}</span><span class="s">,</span>
                            <span class="p">:</span><span class="s">body</span>  <span class="s">"Hello</span> <span class="s">Clojure</span> <span class="s">&amp;</span> <span class="s">Nginx!"</span> <span class="p">;</span><span class="kn">response</span> <span class="s">body</span> <span class="s">can</span> <span class="s">be</span> <span class="s">string,</span> <span class="s">File</span> <span class="s">or</span> <span class="s">Array/Collection/Seq</span> <span class="s">of</span> <span class="s">them</span>
                            <span class="err">}</span><span class="s">)</span>
          <span class="s">'</span><span class="p">;</span>
       <span class="p">}</span>
</pre></div>

<p>Now you can start nginx and access http://localhost:8080/clojure, if some error happens please check error.log file. </p>

<p>For Groovy :</p>

<div class="highlight highlight-nginx"><pre>       <span class="k">location</span> <span class="s">/groovy</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'groovy'</span><span class="p">;</span>
          <span class="kn">handler_code</span> <span class="s">'</span> 
               <span class="s">import</span> <span class="s">nginx.clojure.java.NginxJavaRingHandler</span><span class="p">;</span>
               <span class="kn">import</span> <span class="s">java.util.Map</span><span class="p">;</span>
               <span class="kn">public</span> <span class="s">class</span> <span class="s">HelloGroovy</span> <span class="s">implements</span> <span class="s">NginxJavaRingHandler</span> <span class="p">{</span>
                  <span class="kn">public</span> <span class="s">Object[]</span> <span class="s">invoke(Map&lt;String,</span> <span class="s">Object&gt;</span> <span class="s">request)</span><span class="p">{</span>
                     <span class="kn">return</span> <span class="s">[200,</span> <span class="s">//http</span> <span class="s">status</span> <span class="mi">200</span>
                             <span class="s">["Content-Type":"text/html"],</span> <span class="s">//headers</span> <span class="s">map</span>
                             <span class="s">"Hello,</span> <span class="s">Groovy</span> <span class="s">&amp;</span> <span class="s">Nginx!"]</span><span class="p">;</span> <span class="kn">//response</span> <span class="s">body</span> <span class="s">can</span> <span class="s">be</span> <span class="s">string,</span> <span class="s">File</span> <span class="s">or</span> <span class="s">Array/Collection</span> <span class="s">of</span> <span class="s">them</span>
                  <span class="err">}</span>
               <span class="err">}</span>
          <span class="s">'</span><span class="p">;</span>
       <span class="p">}</span>
</pre></div>

<p>Now you can start nginx and access http://localhost:8080/groovy, if some error happens please check error.log file. </p>

<h3>
<a name="232-reference-of-external-ring-handlers" class="anchor" href="#232-reference-of-external-ring-handlers"><span class="octicon octicon-link"></span></a>2.3.2 Reference of External Ring Handlers</h3>

<p>Please make sure the external Ring handler is in a certain jar file or a directory included by your classpath.
It is also OK if you do not compile the Clojure/Groovy to java class file and just put the source of them in a certain jar file or a directory included by your classpath. </p>

<p>For Clojure the exteranl Ring handler example is here</p>

<div class="highlight highlight-clojure"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">my.hello</span><span class="p">)</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">hello-world</span> <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span>
   <span class="ss">:headers</span> <span class="p">{</span><span class="s">"Content-Type"</span> <span class="s">"text/plain"</span><span class="p">}</span>
   <span class="c1">;response body can be string, File or Array/Collection/Seq of them</span>
   <span class="ss">:body</span> <span class="s">"Hello World"</span><span class="p">})</span>

</pre></div>

<p>Then we can reference it in nginx.conf</p>

<div class="highlight highlight-nginx"><pre>       <span class="k">location</span> <span class="s">/myClojure</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span>
          <span class="kn">handler_name</span> <span class="s">'my.hello/hello-world'</span><span class="p">;</span>
       <span class="p">}</span>
</pre></div>

<p>For more details and more useful examples for <a href="https://github.com/weavejester/compojure">Compojure</a> which is a small routing library for Ring that allows web applications to be composed of small, independent parts. Please refer to <a href="https://github.com/weavejester/compojure">https://github.com/weavejester/compojure</a></p>

<p>For Java</p>

<div class="highlight highlight-java"><pre><span class="kn">package</span> <span class="n">mytest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">nginx</span><span class="o">.</span><span class="na">clojure</span><span class="o">.</span><span class="na">MiniConstants</span><span class="o">.*;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">NginxJavaRingHandler</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> 
                    <span class="n">NGX_HTTP_OK</span><span class="o">,</span> <span class="c1">//http status 200</span>
                    <span class="n">ArrayMap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">CONTENT_TYPE</span><span class="o">,</span> <span class="s">"text/plain"</span><span class="o">),</span> <span class="c1">//headers map</span>
                    <span class="s">"Hello, Java &amp; Nginx!"</span>  <span class="c1">//response body can be string, File or Array/Collection of them</span>
                    <span class="o">};</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<div class="highlight highlight-nginx"><pre>       <span class="k">location</span> <span class="s">/myJava</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'java'</span><span class="p">;</span>
          <span class="kn">handler_name</span> <span class="s">'mytest.Hello'</span><span class="p">;</span>
       <span class="p">}</span>
</pre></div>

<p>For Groovy</p>

<div class="highlight highlight-groovy"><pre>   <span class="kn">package</span> <span class="n">mytest</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">nginx.clojure.java.NginxJavaRingHandler</span><span class="o">;</span>
   <span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloGroovy</span> <span class="kd">implements</span> <span class="n">NginxJavaRingHandler</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">){</span>
         <span class="k">return</span> 
         <span class="o">[</span><span class="mi">200</span><span class="o">,</span>  <span class="c1">//http status 200</span>
          <span class="o">[</span><span class="s2">"Content-Type"</span><span class="o">:</span><span class="s2">"text/html"</span><span class="o">],</span><span class="c1">//headers map</span>
          <span class="s2">"Hello, Groovy &amp; Nginx!"</span> <span class="c1">//response body can be string, File or Array/Collection of them</span>
          <span class="o">];</span> 
      <span class="o">}</span>
   <span class="o">}</span>
</pre></div>

<h3>
<a name="233-pure-java-handler" class="anchor" href="#233-pure-java-handler"><span class="octicon octicon-link"></span></a>2.3.3 Pure Java Handler</h3>

<p>The section is <strong><strong>deprecated</strong></strong>. Please check the above section and use new derective <code>handler_type</code> and <code>handler_name</code> for easier work.</p>

<div class="highlight highlight-java"><pre><span class="kn">package</span> <span class="n">my</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nginx.clojure.Constants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">clojure.lang.AFn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">clojure.lang.IPersistentMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">clojure.lang.PersistentArrayMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloHandler</span> <span class="kd">extends</span> <span class="n">AFn</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">IPersistentMap</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">IPersistentMap</span><span class="o">)</span><span class="n">r</span><span class="o">;</span>

        <span class="c1">//get some info from req. eg. req.valAt(Constants.QUERY_STRING)</span>
        <span class="c1">//....</span>

        <span class="c1">//prepare resps, more details about Ring handler on this site https://github.com/ring-clojure/ring/blob/master/SPEC</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">resps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">Constants</span><span class="o">.</span><span class="na">STATUS</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> 
                <span class="n">Constants</span><span class="o">.</span><span class="na">HEADERS</span><span class="o">,</span> <span class="k">new</span> <span class="nf">PersistentArrayMap</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">Constants</span><span class="o">.</span><span class="na">CONTENT_TYPE</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span><span class="s">"text/plain"</span><span class="o">}),</span>
                <span class="n">Constants</span><span class="o">.</span><span class="na">BODY</span><span class="o">,</span> <span class="s">"Hello Java &amp; Nginx!"</span><span class="o">};</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PersistentArrayMap</span><span class="o">(</span><span class="n">resps</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>

<p>In nginx.conf, eg.</p>

<div class="highlight highlight-nginx"><pre>    <span class="k">location</span> <span class="s">/java</span> <span class="p">{</span>
          <span class="kn">clojure</span><span class="p">;</span>
          <span class="kn">clojure_code</span> <span class="s">'</span> 
               <span class="s">(do</span> <span class="s">(import</span> <span class="s">\'[my</span> <span class="s">HelloHandler])</span> <span class="s">(HelloHandler.)</span> <span class="s">)</span>
          <span class="s">'</span><span class="p">;</span>
       <span class="p">}</span>
</pre></div>

<p>You should set your  JAR files to class path, see <a href="#21-jvm-path--class-path--other-jvm-options">2.1 JVM Path , Class Path &amp; Other JVM Options</a> .</p>

<h2>
<a name="24-chose--coroutine-based-socket-or-asynchronous-socket-or-thread-pool-for-slow-io-operations" class="anchor" href="#24-chose--coroutine-based-socket-or-asynchronous-socket-or-thread-pool-for-slow-io-operations"><span class="octicon octicon-link"></span></a>2.4 Chose  Coroutine based Socket Or Asynchronous Socket Or Thread Pool for slow I/O operations</h2>

<p>If the http service should do some slow I/O operations such as access external http service, database, etc.  nginx worker will be blocked by those operations 
and the new  user  request even static file request will be blocked. It really sucksÔºÅ Before v0.2.0 the only choice is using thread pool but now we have 
three choice :</p>

<ol>
<li>Coroutine based Socket

<ul>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">It's Java Socket API Compatible and work well with largely existing java library such as apache http client, mysql jdbc drivers etc.</li>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">It's non-blocking, cheap, fast and let one java main thread be able to handle thousands of connections.</li>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">Your old code <strong><em>need not be changed</em></strong> and those plain and old java socket based code such as Apache Http Client, MySQL mysql jdbc drivers etc. will be on the fly with epoll/kqueue on Linux/BSD!</li>
<li>
<img class="emoji" title=":worried:" alt=":worried:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f61f.png" height="20" width="20" align="absmiddle">You must do some steps to get the right class waving configuration file and set it in the nginx conf file.</li>
</ul>
</li>
<li>Asynchronous Socket

<ul>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">It's the fastest among those three choice and you can controll it finely.</li>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">It can work with default mode or Coroutine based Socket enabled mode but can't work with Thread Pool mode.</li>
<li>
<img class="emoji" title=":worried:" alt=":worried:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f61f.png" height="20" width="20" align="absmiddle">Your old code <strong><em>must be changed</em></strong> to use the event driven pattern.</li>
</ul>
</li>
<li>Thread Pool

<ul>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">It's a trade off choice and almost all Java server such as Jetty, Tomcat , Glassfish etc. use thread pool to handle http requests.</li>
<li>
<img class="emoji" title=":smiley:" alt=":smiley:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f603.png" height="20" width="20" align="absmiddle">Your old code <strong><em>need not be changed</em></strong>.</li>
<li>
<img class="emoji" title=":worried:" alt=":worried:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f61f.png" height="20" width="20" align="absmiddle">The nginx worker will be blocked after all threads are exhuasted by slow I/O operations.</li>
<li>
<img class="emoji" title=":worried:" alt=":worried:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f61f.png" height="20" width="20" align="absmiddle">Becase the max number of threads is alwarys more smaller than the total number of socket connections supported by Operation Systems and
thread in java is costlier than coroutine, facing large amount of connections this choice isn't as good as Coroutine based choice.</li>
</ul>
</li>
</ol><h3>
<a name="241-enable-coroutine-based-socket" class="anchor" href="#241-enable-coroutine-based-socket"><span class="octicon octicon-link"></span></a>2.4.1 Enable Coroutine based Socket</h3>

<h4>
<a name="1-get-a-user-defined-class-waving-configuration-file-for-your-web-app" class="anchor" href="#1-get-a-user-defined-class-waving-configuration-file-for-your-web-app"><span class="octicon octicon-link"></span></a>1. Get a User Defined Class Waving Configuration File for Your Web App</h4>

<ul>
<li>
<p>Turn on Run Tool Mode</p>

<div class="highlight highlight-nginx"><pre><span class="k">http</span> <span class="p">{</span>
<span class="kn">...</span>

<span class="c1">#To make sure generated Class Waving Configuration File won't be mixed by many workers. </span>
<span class="s">worker_processes</span>  <span class="mi">1</span><span class="p">;</span>

<span class="c1">#turn on run tool mode, t means Tool</span>
<span class="kn">jvm_options</span> <span class="s">"-javaagent:jars/nginx-clojure-0.2.4.jar=tmb"</span><span class="p">;</span>

<span class="c1">#for clojure, you should append clojure core jar, e.g -Djava.class.path=jars/nginx-clojure-0.2.4.jar:mypath-xxx/clojure-1.5.1.jar,please  replace ':' with ';' on windows</span>
<span class="kn">jvm_options</span> <span class="s">"-Xbootclasspath/a:jars/nginx-clojure-0.2.4.jar"</span><span class="p">;</span>
<span class="kn">...</span>
  <span class="err">}</span>
</pre></div>
</li>
<li>
<p>Setting Output Path of Waving Configuration File</p>

<div class="highlight highlight-nginx"><pre><span class="c1">#Optional The default value is $nginx-workdir/nginx.clojure.wave.CfgToolOutFile</span>
<span class="c1">#Setting Output Path of Waving Configuration File, </span>
<span class="k">jvm_options</span> <span class="s">"-Dnginx.clojure.wave.CfgToolOutFile=/tmp/my-wave-cfg.txt"</span><span class="p">;</span>
</pre></div>
</li>
<li>
<p>Setting Dump Configuration Service</p>

<div class="highlight highlight-nginx"><pre>  <span class="k">location</span> <span class="s">/dump</span> <span class="p">{</span>
     <span class="kn">handler_type</span> <span class="s">'java'</span><span class="p">;</span>
     <span class="kn">handler_name</span> <span class="s">'nginx.clojure.java.WaveConfigurationDumpHandler'</span><span class="p">;</span>       
  <span class="p">}</span>
</pre></div>
</li>
<li>Start Nginx which Compiled with Nginx Clojure Module</li>
<li>Run curl or httpclient based junit tests to access your http services which directly or indirectly use Java Socket API, e.g Apache Http Client, MySQL JDBC Driver etc.</li>
<li>
<p>After All responses completed We'll get a generated class waving configuration file e.g <code>my-wave-cfg.txt</code> by access Dump Configuration Service.</p>

<div class="highlight highlight-bash"><pre>/*use curl or just put the Dump Service url to browser and click GO!
 *Dump Service will generate Waving Configuration File to the path defined by 
 *java system property <span class="sb">`</span>nginx.clojure.wave.CfgToolOutFile<span class="sb">`</span>
 */
curl -v http://localhost:8080/dump
</pre></div>

<p>Don't foget reset <code>worker_processes</code> and turn off run tool mode for product enviroument after get class waving configuration</p>
</li>
</ul><h4>
<a name="2-enable-coroutine-support" class="anchor" href="#2-enable-coroutine-support"><span class="octicon octicon-link"></span></a>2. Enable Coroutine Support</h4>

<ul>
<li>
<p>Turn on Coroutine Support</p>

<div class="highlight highlight-nginx"><pre><span class="k">http</span> <span class="p">{</span>
<span class="kn">...</span>
<span class="c1">#make sure it is reset to a normal number after  above step, e.g. 8 worker processes.</span>
<span class="s">worker_processes</span>  <span class="mi">8</span><span class="p">;</span>

<span class="c1">#turn on coroutine mode</span>
<span class="kn">jvm_options</span> <span class="s">"-javaagent:jars/nginx-clojure-0.2.4.jar=mb"</span><span class="p">;</span>

<span class="c1">#append nginx-clojure &amp;  clojure runtime jars to jvm bootclasspath      </span>
<span class="c1">#for win32, class path seperator is ";", e.g "-Xbootclasspath/a:jars/nginx-clojure-0.2.4.jar;jars/clojure-1.5.1.jar"</span>
<span class="kn">jvm_options</span> <span class="s">"-Xbootclasspath/a:jars/nginx-clojure-0.2.4.jar:jars/clojure-1.5.1.jar"</span><span class="p">;</span>

<span class="c1">#coroutine-udfs is a directory to put your User Defined Class Waving Configuration File</span>
<span class="c1">#for win32, class path seperator is ";", e.g "-Djava.class.path=coroutine-udfs;YOUR_CLASSPATH_HERE"</span>
<span class="c1">#Note: DON NOT put nginx-clojure &amp;  clojure runtime jars here, because they have been appened to the jvm bootclasspath</span>
<span class="kn">jvm_options</span> <span class="s">"-Djava.class.path=coroutine-udfs:YOUR_CLASSPATH_HERE"</span><span class="p">;</span>

<span class="c1">#copy the waving configuration file generated from previous step to you any classpath dir e.g. coroutine-udfs</span>
<span class="c1">#setting user defined class waving configuration files which are in the above boot classpath, the seperator is "," </span>
<span class="kn">jvm_options</span> <span class="s">"-Dnginx.clojure.wave.udfs=my-wave-cfg.txt"</span><span class="p">;</span>
<span class="kn">...</span>
<span class="err">}</span>
</pre></div>
</li>
<li>
<p>restart nginx or reload nginx</p>

<p>Now every nginx worker can handle thousands of connections easily! </p>

<p>Those plain and old java socket based code such as Apache Http Client, MySQL mysql jdbc drivers etc. will be on the fly with epoll/kqueue on Linux/BSD!</p>

<p>Nginx won't blocked until nginx connections exhuasted or jvm OutOfMemory!</p>
</li>
</ul><h3>
<a name="242-use-asynchronous-socket" class="anchor" href="#242-use-asynchronous-socket"><span class="octicon octicon-link"></span></a>2.4.2 Use Asynchronous Socket</h3>

<p>Asynchronous Socket Can be used with default mode or coroutined enabled mode without any additional settings. It just a set of API.
It uses event driven pattern and works with a java callback handler or clojure function for callback.
Please check the source code and examples for more details.</p>

<ul>
<li>source: <a href="src/java/nginx/clojure/net/NginxClojureAsynSocket.java">nginx.clojure.net.NginxClojureAsynSocket</a>
</li>
<li>example: 

<ul>
<li>Java <a href="test/java/nginx/clojure/net/SimpleHandler4TestNginxClojureAsynSocket.java">nginx.clojure.net.SimpleHandler4TestNginxClojureAsynSocket</a>
</li>
<li>Clojure <a href="test/clojure/nginx/clojure/asyn_socket_handlers_for_test.clj">nginx.clojure.asyn-socket-handlers-for-test</a>
</li>
</ul>
</li>
</ul><p>In future we'll give more clojure style wrapper and examples. <strong><em>Pull requests are also welcome!</em></strong></p>

<h3>
<a name="243-use-thread-pool" class="anchor" href="#243-use-thread-pool"><span class="octicon octicon-link"></span></a>2.4.3 Use Thread Pool</h3>

<p>If your tasks are often blocked by slow I/O operations, the thread pool method can make the nginx worker not blocked until
all threads are exhuasted. When facing large amount of connections this choice isn't as good as above coroutine based choice or asynchronous socket.</p>

<p>eg.</p>

<div class="highlight highlight-nginx"><pre>
<span class="c1">#turn off coroutine mode,  n means do nothing. You can also comment this line to turn off coroutine mode </span>
<span class="k">jvm_options</span> <span class="s">"-javaagent:jars/nginx-clojure-0.2.4.jar=nmb"</span><span class="p">;</span>

<span class="k">jvm_workers</span> <span class="mi">40</span><span class="p">;</span>
</pre></div>

<p>Now Nginx-Clojure will create a thread pool with fixed 40 threads  per JVM instance/Nginx worker to handle requests. If you get more memory, you can set
a bigger number.</p>

<h2>
<a name="25-nginx-rewrite-handler" class="anchor" href="#25-nginx-rewrite-handler"><span class="octicon octicon-link"></span></a>2.5 Nginx rewrite handler</h2>

<p>A nginx rewrite handler can be used to set var or return errors before proxy pass or content ring handler. 
If the rewrite handler returns <code>phrase-done</code> (Clojure) or  <code>PHRASE_DONE</code> (Groovy/Java), nginx will continue to invoke proxy_pass or 
content ring handler.
If the rewrite handler returns a general response, nginx will send this response to the client and stop to continue to invoke proxy_pass or 
content ring handler.</p>

<h3>
<a name="251-simple-example-about-nginx-rewrite-handler" class="anchor" href="#251-simple-example-about-nginx-rewrite-handler"><span class="octicon octicon-link"></span></a>2.5.1 Simple Example about Nginx rewrite handler</h3>

<p>Here's a simple clojure example for Nginx rewrite handler :</p>

<div class="highlight highlight-nginx"><pre>
       <span class="k">set</span> <span class="nv">$myvar</span> <span class="s">""</span><span class="p">;</span>

       <span class="k">location</span> <span class="s">/rewritesimple</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span>
          <span class="kn">handler_rewrite_code</span> <span class="s">'</span>
           <span class="s">(do</span> <span class="s">(use</span> <span class="s">\'[nginx.clojure.core])</span> 
                        <span class="s">(fn[req]</span>
                          <span class="s">(set-ngx-var!</span> <span class="s">req</span> <span class="s">"myvar"</span> <span class="s">"Hello")</span>
                          <span class="s">phrase-done))</span>
          <span class="s">'</span><span class="p">;</span>
          <span class="kn">handler_code</span> <span class="s">'</span>
           <span class="s">(do</span> <span class="s">(use</span> <span class="s">\'[nginx.clojure.core])</span> 
                        <span class="s">(fn[req]</span>
                          <span class="s">(set-ngx-var!</span> <span class="s">req</span> <span class="s">"myvar"</span> 
                                     <span class="s">(str</span> <span class="s">(get-ngx-var</span> <span class="s">req</span> <span class="s">"myvar")</span> <span class="s">","</span> <span class="s">"Xfeep!"))</span>
                          <span class="p">{</span>
                            <span class="kn">:status</span> <span class="mi">200</span><span class="s">,</span>
                            <span class="p">:</span><span class="s">headers</span> <span class="p">{</span><span class="kn">"content-type"</span> <span class="s">"text/plain"</span><span class="err">}</span><span class="s">,</span>
                            <span class="p">:</span><span class="s">body</span>  <span class="s">(get-ngx-var</span> <span class="s">req</span> <span class="s">"myvar")</span> 
                            <span class="err">}</span><span class="s">))</span>
          <span class="s">'</span><span class="p">;</span>
       <span class="p">}</span>    

</pre></div>

<h3>
<a name="252-simple-dynamic-balancer-by-nginx-rewrite-handler" class="anchor" href="#252-simple-dynamic-balancer-by-nginx-rewrite-handler"><span class="octicon octicon-link"></span></a>2.5.2 Simple Dynamic Balancer By Nginx rewrite handler</h3>

<p>We can alos use this feature to complete a simple dynamic balancer , e.g.</p>

<div class="highlight highlight-nginx"><pre>
       <span class="k">set</span> <span class="nv">$myhost</span> <span class="s">""</span><span class="p">;</span>

       <span class="k">location</span> <span class="s">/myproxy</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span>
          <span class="kn">handler_rewrite_code</span> <span class="s">'</span>
           <span class="s">(do</span> <span class="s">(use</span> <span class="s">\'[nginx.clojure.core])</span> 
                        <span class="s">(fn[req]</span>
                          <span class="p">;</span><span class="kn">compute</span> <span class="s">myhost</span> <span class="s">(upstream</span> <span class="s">name</span> <span class="s">or</span> <span class="s">real</span> <span class="s">host</span> <span class="s">name)</span> <span class="s">based</span> <span class="s">req</span> <span class="s">&amp;</span> <span class="s">remote</span> <span class="s">service,</span> <span class="s">e.g.</span>
                          <span class="s">(let</span> <span class="s">[myhost</span> <span class="s">(compute-myhost</span> <span class="s">req)])</span>
                          <span class="s">(set-ngx-var!</span> <span class="s">req</span> <span class="s">"myhost"</span> <span class="s">myhost)</span>
                          <span class="s">phrase-done))</span>
          <span class="s">'</span><span class="p">;</span>
          <span class="kn">proxy_pass</span> <span class="nv">$myhost</span>
       <span class="err">}</span>    

</pre></div>

<p>The equivalent java code is here</p>

<div class="highlight highlight-java"><pre>
<span class="kn">package</span> <span class="n">my</span><span class="o">.</span><span class="na">test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">nginx</span><span class="o">.</span><span class="na">clojure</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">Constants</span><span class="o">.*;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyRewriteProxyPassHandler</span> <span class="kd">implements</span> <span class="n">NginxJavaRingHandler</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">myhost</span> <span class="o">=</span> <span class="n">computeMyHost</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
            <span class="n">NginxClojureRT</span><span class="o">.</span><span class="na">setNGXVariable</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">nativeRequest</span><span class="o">(),</span> <span class="s">"myhost"</span><span class="o">,</span> <span class="n">myhost</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">PHRASE_DONE</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="n">String</span> <span class="nf">computeMyHost</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//compute a upstream name or host name;</span>
        <span class="o">}</span>
    <span class="o">}</span>

</pre></div>

<p>Then we set the java rewrtite handler in nginx.conf</p>

<div class="highlight highlight-nginx"><pre>
       <span class="k">set</span> <span class="nv">$myhost</span> <span class="s">""</span><span class="p">;</span>

       <span class="k">location</span> <span class="s">/myproxy</span> <span class="p">{</span>
          <span class="kn">handler_type</span> <span class="s">'java'</span><span class="p">;</span>
          <span class="kn">handler_rewrite_name</span> <span class="s">'my.test.MyRewriteProxyPassHandler'</span><span class="p">;</span>
          <span class="kn">proxy_pass</span> <span class="nv">$myhost</span>
       <span class="err">}</span>    

</pre></div>

<h3>
<a name="253-simple-access-controller-by-nginx-rewrite-handler" class="anchor" href="#253-simple-access-controller-by-nginx-rewrite-handler"><span class="octicon octicon-link"></span></a>2.5.3 Simple Access Controller By Nginx rewrite handler</h3>

<p>For clojure</p>

<div class="highlight highlight-nginx"><pre> <span class="k">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span>
 <span class="k">handler_rewrite_code</span> <span class="s">'</span>
     <span class="s">(do</span> <span class="s">(use</span> <span class="s">\'[nginx.clojure.core])</span> 
           <span class="s">(import</span> <span class="s">\'[com\.test</span> <span class="s">AuthenticationHandler])</span> 
                <span class="s">(fn[req]</span>
                          <span class="s">(if</span> <span class="s">((AuthenticationHandler.)</span>  <span class="s">req)</span>
                             <span class="p">;</span><span class="k">AuthenticationHandler</span> <span class="s">returns</span> <span class="s">true</span> <span class="s">so</span> <span class="s">we</span> <span class="s">go</span> <span class="s">to</span> <span class="s">proxy_pass</span>
                             <span class="s">phrase-done</span> 
                             <span class="p">;</span><span class="k">else</span> <span class="s">return</span> <span class="mi">403</span>
                             <span class="p">{</span><span class="kn">:status</span> <span class="mi">403</span><span class="err">}</span>
                             <span class="s">)))</span>
          <span class="s">'</span><span class="p">;</span>
<span class="kn">proxy_pass</span> <span class="s">http://localhost:8084</span><span class="p">;</span>
</pre></div>

<p>For Java</p>

<ul>
<li>
<p>nginx.conf</p>

<div class="highlight highlight-nginx"><pre>    <span class="k">handler_type</span> <span class="s">'java'</span><span class="p">;</span>
    <span class="k">handler_rewrite_name</span> <span class="s">'com.test.MyHandler'</span><span class="p">;</span>
    <span class="k">proxy_pass</span> <span class="s">http://localhost:8084</span><span class="p">;</span>
</pre></div>
</li>
<li>
<p>MyHandler.java</p>

<div class="highlight highlight-java"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">nginx</span><span class="o">.</span><span class="na">clojure</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">Constants</span><span class="o">.*;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">implements</span> <span class="n">NginxJavaRingHandler</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>

       <span class="cm">/*do some computing here*/</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">goto</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">pass</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">return</span>  <span class="n">PHRASE_DONE</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>  <span class="c1">//return 403</span>
              <span class="k">return</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">resps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span>
                              <span class="n">Constants</span><span class="o">.</span><span class="na">STATUS</span><span class="o">,</span> <span class="mi">403</span><span class="o">,</span> 
                             <span class="c1">//add some headers -- optional for no-20X response</span>
                             <span class="c1">//Constants.HEADERS, nginx.clojure.java.ArrayMap.create(new Object[]{CONTENT_TYPE,"text/plain"}),</span>
                             <span class="c1">//body text -- optional for no-20X response</span>
                             <span class="c1">// Constants.BODY, "xxxxxxxxxxxxxx!"</span>
                             <span class="o">};</span>
        <span class="o">}</span>
    <span class="o">}</span>

</pre></div>
</li>
</ul><h1>
<a name="3-more-about-nginx-clojure" class="anchor" href="#3-more-about-nginx-clojure"><span class="octicon octicon-link"></span></a>3. More about Nginx-Clojure</h1>

<h2>
<a name="31-handle-multiple-coroutine-based-sockets-parallel" class="anchor" href="#31-handle-multiple-coroutine-based-sockets-parallel"><span class="octicon octicon-link"></span></a>3.1 Handle Multiple Coroutine Based Sockets Parallel</h2>

<p>Sometimes we need invoke serveral remote services before completing the ring  response. For better performance we need a way to handle multiple sockets parallel in sub coroutines.</p>

<p>e.g. fetch two page parallel by clj-http</p>

<div class="highlight highlight-clojure"><pre>   <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">r1</span>, <span class="nv">r2</span><span class="p">]</span> 
                <span class="p">(</span><span class="nf">co-pvalues</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">"http://service1-url"</span><span class="p">)</span> 
                            <span class="p">(</span><span class="nf">client/get</span> <span class="s">"http://service2-url"</span><span class="p">))]</span>
    <span class="c1">;println bodies of two remote response</span>
    <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="ss">:body</span> <span class="nv">r1</span><span class="p">)</span> <span class="s">"====\n"</span> <span class="p">(</span><span class="ss">:body</span> <span class="nv">r2</span><span class="p">)</span> <span class="p">))</span>
</pre></div>

<p>Here <code>co-pvalues</code> is also non-blocking and coroutine based. In fact it will create two sub coroutines to handle two sockets.</p>

<p>For Java/Groovy, we can use <code>NginxClojureRT.coBatchCall</code> to do the same thing. Here 's a simple example for Groovy.</p>

<div class="highlight highlight-groovy"><pre>     <span class="kt">def</span> <span class="o">(</span><span class="n">r1</span><span class="o">,</span> <span class="n">r2</span><span class="o">)</span> <span class="o">=</span> <span class="n">NginxClojureRT</span><span class="o">.</span><span class="na">coBatchCall</span><span class="o">(</span> 
       <span class="o">{</span><span class="s2">"http://mirror.bit.edu.cn/apache/httpcomponents/httpclient/"</span><span class="o">.</span><span class="na">toURL</span><span class="o">().</span><span class="na">text</span><span class="o">},</span>
       <span class="o">{</span><span class="s2">"http://mirror.bit.edu.cn/apache/httpcomponents/httpcore/"</span><span class="o">.</span><span class="na">toURL</span><span class="o">().</span><span class="na">text</span><span class="o">})</span>
     <span class="k">return</span> <span class="o">[</span><span class="mi">200</span><span class="o">,</span> <span class="o">[</span><span class="s2">"Content-Type"</span><span class="o">:</span><span class="s2">"text/html"</span><span class="o">],</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">r2</span><span class="o">];</span>

</pre></div>

<h2>
<a name="32-shared-map-among-nginx-workers" class="anchor" href="#32-shared-map-among-nginx-workers"><span class="octicon octicon-link"></span></a>3.2 Shared Map among Nginx Workers</h2>

<p>Generally use redis or memorycached is the better choice to implement a shared map among Nginx workers. We can do some initialization of the 
shared map by following the guide of <a href="#22-initialization-handler-for-nginx-worker">2.2 Initialization Handler for nginx worker</a>.
If you like shared map managed in nginx  process better than redis or memcached, you can choose <a href="https://github.com/OpenHFT/HugeCollections/wiki">SharedHashMap</a><br>
which is fast and based on Memory Mapped File so that it can store  large amout of records and won't need too much java heap memory.</p>

<h2>
<a name="33-user-defined-http-method" class="anchor" href="#33-user-defined-http-method"><span class="octicon octicon-link"></span></a>3.3 User Defined Http Method</h2>

<p>Some web services need user defined http request method to define special operations beyond standard http request methods. </p>

<p>e.g. We use <code>MYUPLOAD</code> to upload a file and overwrite the one if it exists.  The <code>curl</code> command maybe is </p>

<div class="highlight highlight-bash"><pre>curl   -v  -X MYUPLOAD  --upload-file post-test-data <span class="se">\</span>
<span class="s2">"http://localhost:8080/myservice"</span> 
</pre></div>

<p>In the nginx.conf, we can use <code>always_read_body on;</code> to force nginx to read http body.</p>

<div class="highlight highlight-nginx"><pre>
<span class="k">location</span> <span class="s">/myservice</span> <span class="p">{</span>
         <span class="kn">handler_type</span> <span class="s">'clojure'</span><span class="p">;</span>
         <span class="kn">always_read_body</span> <span class="no">on</span><span class="p">;</span>
         <span class="kn">handler_code</span> <span class="s">'....'</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>

<h1>
<a name="4-useful-links" class="anchor" href="#4-useful-links"><span class="octicon octicon-link"></span></a>4. Useful Links</h1>

<ul>
<li><a href="https://github.com/ring-clojure/ring/wiki">Ring Documents</a></li>
<li><a href="https://github.com/weavejester/compojure/wiki">Comojure Documents</a></li>
<li>
<a href="test/nginx-working-dir/conf/nginx.conf">Simple Examples</a> in Nginx Clojure Testing Configuration &amp; <a href="test/clojure/nginx/clojure/test_all.clj">Testing Client Code</a>
</li>
<li><p><a href="test/clojure/nginx/clojure/ring_handlers_for_test.clj">Nginx Clojure Ring Handlers Examples for Testing</a> (Testing with Ring Core 1.2.1)</p></li>
</ul><h1>
<a name="5-license" class="anchor" href="#5-license"><span class="octicon octicon-link"></span></a>5. License</h1>

<p>Copyright <g-emoji alias="copyright" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/00a9.png">¬©</g-emoji> 2013-2014 Zhang, Yuexiang (xfeep) and released under the BSD 3-Clause license.</p>

<p>This program uses:</p>

<ul>
<li>Re-rooted ASM bytecode engineering library which is distributed under the BSD 3-Clause license</li>
<li>Modified Continuations Library Written by Matthias Mann  is distributed under the BSD 3-Clause license</li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-53526038-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
